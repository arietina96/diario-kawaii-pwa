<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Diario Alimentare Kawaii â€“ Versione Sincronizzata</title>
<link rel="manifest" href="manifest.json">
<style>
/* Stili esistenti */
body {font-family: Comic Sans MS,cursive; background:#fff0f8; color:#333; padding:1rem;}
h1 {color:#ff5fa2; text-align:center;}
.meal {background:linear-gradient(135deg,#ffd6e8,#ffe6f0); border-radius:20px; padding:1rem; margin-bottom:1rem; box-shadow:0 4px 12px rgba(0,0,0,0.1);}
.itemsContainer {display:flex; flex-wrap:wrap; gap:0.5rem;}
.item {background:#fff; padding:0.6rem 0.8rem; border-radius:16px; width:150px; box-shadow:0 2px 6px rgba(0,0,0,0.1); text-align:center; position:relative;}
.item button {position:absolute; top:2px; right:2px; background:#ff5fa2; color:#fff; border:none; border-radius:50%; cursor:pointer; width:20px; height:20px; font-size:12px;}
.mealTotals {background:linear-gradient(135deg,#ff9ac9,#ffb0d4); padding:0.6rem; border-radius:14px; margin-top:0.5rem; font-weight:700;}
.recipeDiv {background:linear-gradient(135deg,#fff0ff,#ffe6ff); padding:0.6rem; border-radius:14px; margin-top:0.5rem;}
.recipeDiv img {max-width:100%; border-radius:12px; margin-top:0.3rem;}
.sportDiv {background:linear-gradient(135deg,#ffdae6,#ffd6e8); padding:0.6rem; border-radius:14px; margin-top:0.5rem;}
.modal {display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:100;}
.modalContent {background:#fff; padding:1rem; border-radius:20px; width:80%; max-height:80%; overflow-y:auto;}
input, select, textarea {font-family: Comic Sans MS,cursive; margin-bottom:0.5rem; width:95%;}
button {padding:0.6rem 1rem; border-radius:16px; border:none; background:#ffb6c1; color:#fff; font-weight:bold; cursor:pointer; margin-right:0.3rem;}
button:hover {background:#ff5fa2;}
table {border-collapse:collapse; margin-top:0.5rem; width:100%;}
table, th, td {border:1px solid #ff5fa2; padding:0.4rem; text-align:center; border-radius:6px;}
#totals-day {background:linear-gradient(135deg,#ffe6f0,#ffd6e8); margin-top:2rem; font-size:1.2rem; padding:0.8rem; border-radius:14px;}
</style>
<script>
// PWA Service Worker (richiede il file sw.js)
if ('serviceWorker' in navigator) {
Â  Â  navigator.serviceWorker.register('sw.js');
}
</script>
</head>
<body>

<h1>ğŸ“ Diario Alimentare Kawaii</h1>

<datalist id="foodList"></datalist>

<label>ğŸ“… Seleziona data:</label>
<input type="date" id="dateInput" onchange="changeDay(this.value)">

<button onclick="saveSyncJSONBin()">ğŸ”„ Salva/Sincronizza su Cloud</button>
<button onclick="loadSyncJSONBin()">ğŸ“¥ Carica da Cloud (o locale)</button>

<div id="diaryContainer"></div>
<div id="totals-day"><b>Totale giornata:</b> ğŸ”¥ 0 kcal | ğŸ 0 g | ğŸ¥š 0 g | ğŸ¥‘ 0 g<br>
<b>Totale selezionato:</b> ğŸ”¥ 0 kcal | ğŸ 0 g | ğŸ¥š 0 g | ğŸ¥‘ 0 g</div>

<button onclick="showNutritionModal()">ğŸ“Š Tabelle nutrizionali</button>
<button onclick="showAllRecipes()">ğŸ“– Tutte le ricette</button>

<div id="nutritionModal" class="modal">
Â  Â  <div class="modalContent">
Â  Â  Â  Â  <h2>ğŸ“Š Tabelle nutrizionali</h2>
Â  Â  Â  Â  <table id="nutritionTable"></table>
Â  Â  Â  Â  <button onclick="addNewFood()">â• Aggiungi alimento</button>
Â  Â  Â  Â  <button onclick="closeNutritionModal()">Chiudi</button>
Â  Â  </div>
</div>

<div id="recipeModal" class="modal">
Â  Â  <div class="modalContent">
Â  Â  Â  Â  <h2>ğŸ“– Inserisci o seleziona ricetta</h2>
Â  Â  Â  Â  <select id="existingRecipeSelect"><option value="">--Seleziona ricetta esistente--</option></select>
Â  Â  Â  Â  <input type="text" id="recipeName" placeholder="Nome ricetta">
Â  Â  Â  Â  <textarea id="recipeIngredients" placeholder="Ingredienti (uno per riga)"></textarea>
Â  Â  Â  Â  <textarea id="recipeProcedure" placeholder="Procedimento"></textarea>
Â  Â  Â  Â  <input type="text" id="recipeCookTime" placeholder="Tempo di cottura">
Â  Â  Â  Â  <input type="text" id="recipeMethod" placeholder="Metodo (padella, forno, crudo...)">
Â  Â  Â  Â  <input type="text" id="recipeImg" placeholder="Link immagine o sito (opzionale)">
Â  Â  Â  Â  <button onclick="saveRecipeForMeal()">ğŸ’¾ Salva ricetta</button>
Â  Â  Â  Â  <button onclick="deleteRecipeForMeal()">ğŸ—‘ï¸ Elimina ricetta</button>
Â  Â  Â  Â  <button onclick="closeRecipeModal()">Chiudi</button>
Â  Â  </div>
</div>

<div id="allRecipesModal" class="modal">
Â  Â  <div class="modalContent">
Â  Â  Â  Â  <h2>ğŸ“– Tutte le ricette</h2>
Â  Â  Â  Â  <div id="allRecipesContainer"></div>
Â  Â  Â  Â  <button onclick="closeAllRecipesModal()">Chiudi</button>
Â  Â  </div>
</div>


<script>
// --- Costanti e variabili
const MEALS = ["Colazione","Spuntino","Pranzo","Merenda","Cena","Dopocena"];
const activities = [
Â  Â  {name:"Tapis roulant", kcalPerMin:10},
Â  Â  {name:"Ballo Caraibico", kcalPerMin:8},
Â  Â  {name:"Addominali in palestra", kcalPerMin:7},
Â  Â  {name:"Passeggiata veloce", kcalPerMin:5},
Â  Â  {name:"Stretching", kcalPerMin:4},
Â  Â  {name:"Yoga", kcalPerMin:3}
];

// Dati iniziali (saranno sovrascritti dal localStorage o JSONBin)
let foodDB = [
Â  Â  {name:"Kiwi", kcal100:49, carbs100:9, protein100:0, fat100:0, img:""},
Â  Â  {name:"Zucca", kcal100:30, carbs100:6.9, protein100:0, fat100:0, img:""},
Â  Â  {name:"Fragole", kcal100:30, carbs100:5.3, protein100:0, fat100:0, img:""},
Â  Â  {name:"Prugne secche", kcal100:65, carbs100:51.2, protein100:0, fat100:0, img:""},
Â  Â  {name:"Zucchina", kcal100:15, carbs100:0, protein100:0, fat100:0, img:""}
];

let recipeDB = {};
let diary = {};
let currentDate = new Date().toISOString().split("T")[0];
let currentMealForRecipe = null;

// --- CONFIGURAZIONE CHIAVI JSONBin (INSERITE) ---
const JSONBIN_BIN_ID = "6912f6b1d0ea881f40e14975";Â 
const JSONBIN_MASTER_KEY = "$2a$10$/oqt/konWBpXfYJhVx2EHONSYiQZCSS8PCD7IqU3yPAkckNuE8lP2"; // Chiave di Scrittura (X-Master-Key)
const JSONBIN_READ_KEY = "$2a$10$ClNFWbnoyUzJUFS5AsSv0.PsFdhP3D4PjGFXHiLChKSA9j0.TPakq"; // Chiave di Lettura (X-Access-Key)


// --- Funzioni di utilitÃ 
function updateFoodList(){
Â  Â  const list = document.getElementById('foodList');
Â  Â  list.innerHTML="";
Â  Â  foodDB.forEach(f=>{
Â  Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  Â  opt.value = f.name;
Â  Â  Â  Â  list.appendChild(opt);
Â  Â  });
}

function initDiaryForDate(date){
Â  Â  if(!diary[date]) diary[date]={};
Â  Â  MEALS.forEach(m=>{
Â  Â  Â  Â  if(!diary[date][m]) diary[date][m]=[];
Â  Â  });
}

function renderDiary(){
Â  Â  const container = document.getElementById('diaryContainer');
Â  Â  container.innerHTML="";
Â  Â  MEALS.forEach(meal=>{
Â  Â  Â  Â  let mealDiv = document.createElement('div');
Â  Â  Â  Â  mealDiv.className="meal";
Â  Â  Â  Â  mealDiv.innerHTML = `<h2>${meal}</h2>
Â  Â  Â  Â  Â  Â  <input type="text" id="input-${meal}" placeholder="Nome alimento..." list="foodList">
Â  Â  Â  Â  Â  Â  <input type="number" id="qty-${meal}" placeholder="QuantitÃ  (g/ml)" style="width:120px;">
Â  Â  Â  Â  Â  Â  <button onclick="addFood('${meal}')">â• Aggiungi alimento</button>
Â  Â  Â  Â  Â  Â  <button onclick="insertDefault('${meal}')">ğŸ“Œ Inserisci schema predefinito</button>
Â  Â  Â  Â  Â  Â  <div class="itemsContainer" id="items-${meal}"></div>
Â  Â  Â  Â  Â  Â  <div class="mealTotals" id="totals-${meal}"></div>
Â  Â  Â  Â  Â  Â  <div class="recipeDiv" id="recipe-${meal}"></div>`;
Â  Â  Â  Â  container.appendChild(mealDiv);
Â  Â  Â  Â  updateMeal(meal);
Â  Â  });
Â  Â  updateDayTotals();
Â  Â  showSport();
}

// --- Funzione di salvataggio locale AUTOMATICO (chiamata ad ogni modifica)
function autoSaveKawaii(){
Â  Â  initDiaryForDate(currentDate);
Â  Â  const allData = { diary, foodDB, recipeDB, savedAt: new Date().toISOString() };
Â  Â  try {
Â  Â  Â  Â  localStorage.setItem("kawaiiAllData", JSON.stringify(allData));
Â  Â  } catch (e) {
Â  Â  Â  Â  console.warn("Impossibile salvare localmente:", e);
Â  Â  }
}

// --- Alimenti
function addFood(meal){
Â  Â  const name = document.getElementById(`input-${meal}`).value.trim();
Â  Â  const qty = parseFloat(document.getElementById(`qty-${meal}`).value);
Â  Â  if(!name || isNaN(qty) || qty<=0){ alert("Inserisci nome e quantitÃ  valida"); return; }
Â  Â  
Â  Â  // Correzione: Cerca l'alimento usando il nome normalizzato (pulito)
Â  Â  const cleanName = name.toLowerCase();
Â  Â  const f = foodDB.find(x => x.name.toLowerCase() === cleanName);
Â  Â  
Â  Â  if(!f){ alert("Alimento non trovato"); return; }
Â  Â  
Â  Â  diary[currentDate][meal].push({...f, quantity:qty});
Â  Â  document.getElementById(`input-${meal}`).value="";
Â  Â  document.getElementById(`qty-${meal}`).value="";
Â  Â  updateMeal(meal);
Â  Â  autoSaveKawaii();Â 
}

function insertDefault(meal){
Â  Â  const defaults = {
Â  Â  Â  Â  "Colazione":[{name:"Kiwi",quantity:80},{name:"Zucca",quantity:66},{name:"Fragole",quantity:100},{name:"Prugne secche",quantity:60}],
Â  Â  Â  Â  "Pranzo":[{name:"Zucca",quantity:200},{name:"Zucchina",quantity:450}],
Â  Â  Â  Â  "Cena":[{name:"Zucca",quantity:200},{name:"Zucchina",quantity:450}],
Â  Â  Â  Â  "Merenda":[{name:"Kiwi",quantity:160},{name:"Fragole",quantity:100}],
Â  Â  Â  Â  "Dopocena":[{name:"Kiwi",quantity:80},{name:"Fragole",quantity:50}],
Â  Â  Â  Â  "Spuntino":[{name:"Fragole",quantity:50}]
Â  Â  };
Â  Â  defaults[meal].forEach(d=>{
Â  Â  Â  Â  const f = foodDB.find(x=>x.name===d.name);
Â  Â  Â  Â  if(f) diary[currentDate][meal].push({...f,quantity:d.quantity,isDefault:true});
Â  Â  });
Â  Â  updateMeal(meal);
Â  Â  autoSaveKawaii();Â 
}

function editFoodInMeal(meal,index){
Â  Â  const f = diary[currentDate][meal][index];
Â  Â  const newQty = parseFloat(prompt(`QuantitÃ  di ${f.name} (g/ml):`, f.quantity));
Â  Â  if(!isNaN(newQty) && newQty>0){
Â  Â  Â  Â  diary[currentDate][meal][index].quantity = newQty;
Â  Â  Â  Â  updateMeal(meal);
Â  Â  Â  Â  autoSaveKawaii();Â 
Â  Â  }
}

function removeFood(meal,index){
Â  Â  if(confirm("Vuoi eliminare questo alimento?")){
Â  Â  Â  Â  diary[currentDate][meal].splice(index,1);
Â  Â  Â  Â  updateMeal(meal);
Â  Â  Â  Â  autoSaveKawaii();Â 
Â  Â  }
}

function updateMeal(meal){
Â  Â  const container = document.getElementById(`items-${meal}`);
Â  Â  container.innerHTML="";
Â  Â  let totalKcal=0, totalCarbs=0, totalProt=0, totalFat=0;
Â  Â  diary[currentDate][meal].forEach((f,i)=>{
Â  Â  Â  Â  const kcal = f.kcal100*f.quantity/100;
Â  Â  Â  Â  const carbs = f.carbs100*f.quantity/100;
Â  Â  Â  Â  const prot = f.protein100*f.quantity/100;
Â  Â  Â  Â  const fat = f.fat100*f.quantity/100;
Â  Â  Â  Â  totalKcal += kcal; totalCarbs += carbs; totalProt += prot; totalFat += fat;
Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  div.className="item";
Â  Â  Â  Â  div.innerHTML = `<b>${f.name}</b><br>ğŸ´ ${f.quantity}g/ml<br>ğŸ”¥ ${kcal.toFixed(1)} kcal<br>ğŸ ${carbs.toFixed(1)}g<br>ğŸ¥š ${prot.toFixed(1)}g<br>ğŸ¥‘ ${fat.toFixed(1)}g
Â  Â  Â  Â  Â  Â  <button style="top:2px; right:22px;" onclick="editFoodInMeal('${meal}',${i})">âœï¸</button>
Â  Â  Â  Â  Â  Â  <button onclick="removeFood('${meal}',${i})">ğŸ—‘ï¸</button>`;
Â  Â  Â  Â  container.appendChild(div);
Â  Â  });

Â  Â  document.getElementById(`totals-${meal}`).innerHTML = `Totale: ğŸ”¥ ${totalKcal.toFixed(1)} kcal | ğŸ ${totalCarbs.toFixed(1)} g | ğŸ¥š ${totalProt.toFixed(1)} g | ğŸ¥‘ ${totalFat.toFixed(1)} g`;

Â  Â  // Ricetta pasto
Â  Â  const recipeDiv = document.getElementById(`recipe-${meal}`);
Â  Â  recipeDiv.innerHTML = `<button onclick="openRecipeModal('${meal}')">ğŸ“– Aggiungi/Seleziona ricetta</button>`;
Â  Â  if(diary[currentDate][meal].recipe && recipeDB[diary[currentDate][meal].recipe]){
Â  Â  Â  Â  const r = recipeDB[diary[currentDate][meal].recipe];
Â  Â  Â  Â  recipeDiv.innerHTML += `<br><b>ğŸ“– ${diary[currentDate][meal].recipe}</b><br>ğŸ³ Ingredienti: ${r.ingredients}<br>ğŸ“ Procedimento: ${r.procedure}<br>â±ï¸ Tempo: ${r.cookTime}<br>ğŸ”¥ Metodo: ${r.method}${r.img?`<br><a href="${r.img}" target="_blank">ğŸ”— Immagine</a>`:""}`;
Â  Â  }
Â  Â  updateDayTotals();
}

function updateDayTotals(){
Â  Â  let totalKcal=0, totalCarbs=0, totalProt=0, totalFat=0;
Â  Â  let selKcal=0, selCarbs=0, selProt=0, selFat=0;
Â  Â  MEALS.forEach(meal=>{
Â  Â  Â  Â  if (diary[currentDate][meal]) {
Â  Â  Â  Â  Â  Â  diary[currentDate][meal].forEach(f=>{
Â  Â  Â  Â  Â  Â  Â  Â  const kcal = f.kcal100*f.quantity/100;
Â  Â  Â  Â  Â  Â  Â  Â  const carbs = f.carbs100*f.quantity/100;
Â  Â  Â  Â  Â  Â  Â  Â  const prot = f.protein100*f.quantity/100;
Â  Â  Â  Â  Â  Â  Â  Â  const fat = f.fat100*f.quantity/100;
Â  Â  Â  Â  Â  Â  Â  Â  totalKcal += kcal; totalCarbs += carbs; totalProt += prot; totalFat += fat;
Â  Â  Â  Â  Â  Â  Â  Â  if(!f.isDefault){ selKcal += kcal; selCarbs += carbs; selProt += prot; selFat += fat; }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  });
Â  Â  document.getElementById('totals-day').innerHTML = `<b>Totale giornata:</b> ğŸ”¥ ${totalKcal.toFixed(1)} kcal | ğŸ ${totalCarbs.toFixed(1)} g | ğŸ¥š ${totalProt.toFixed(1)} g | ğŸ¥‘ ${totalFat.toFixed(1)} g<br><b>Totale selezionato:</b> ğŸ”¥ ${selKcal.toFixed(1)} kcal | ğŸ ${selCarbs.toFixed(1)} g | ğŸ¥š ${selProt.toFixed(1)} g | ğŸ¥‘ ${selFat.toFixed(1)} g`;
}

// --- Sport
function showSport(){
Â  Â  const existing = document.querySelector('.sportDiv');
Â  Â  if(existing) existing.remove();
Â  Â  const div = document.createElement('div');
Â  Â  div.className="sportDiv";
Â  Â  div.innerHTML = `ğŸƒâ€â™‚ï¸ AttivitÃ  fisica consigliata:<br>`;
Â  Â Â 
Â  Â  let totalKcalDay = 0;
Â  Â  MEALS.forEach(meal=>{
Â  Â  Â  Â  let kcal=0;
Â  Â  Â  Â  if (diary[currentDate][meal]) {
Â  Â  Â  Â  Â  Â  diary[currentDate][meal].forEach(f=>{ kcal += f.kcal100*f.quantity/100; });
Â  Â  Â  Â  }
Â  Â  Â  Â  totalKcalDay += kcal;
Â  Â  });

Â  Â  if (totalKcalDay > 0) {
Â  Â  Â  Â  div.innerHTML += `<b>Totale Calorico Giornaliero:</b> ğŸ”¥ ${totalKcalDay.toFixed(1)} kcal<br>`;
Â  Â  Â  Â  div.innerHTML += `<b>Tempo AttivitÃ  Necessario:</b><br>`;
Â  Â  Â  Â  activities.forEach(act=>{
Â  Â  Â  Â  Â  Â  div.innerHTML += `- ${act.name}: ${Math.ceil(totalKcalDay/act.kcalPerMin)} min<br>`;
Â  Â  Â  Â  });
Â  Â  } else {
Â  Â  Â  Â  div.innerHTML += `Non ci sono ancora calorie registrate per oggi.`;
Â  Â  }

Â  Â  document.body.appendChild(div);
}

// --- Ricette
function openRecipeModal(meal){
Â  Â  currentMealForRecipe = meal;
Â  Â  document.getElementById('recipeName').value="";
Â  Â  document.getElementById('recipeIngredients').value="";
Â  Â  document.getElementById('recipeProcedure').value="";
Â  Â  document.getElementById('recipeCookTime').value="";
Â  Â  document.getElementById('recipeMethod').value="";
Â  Â  document.getElementById('recipeImg').value="";
Â  Â  const sel = document.getElementById('existingRecipeSelect');
Â  Â  sel.innerHTML = `<option value="">--Seleziona ricetta esistente--</option>`;
Â  Â  Object.keys(recipeDB).sort().forEach(r=>{
Â  Â  Â  Â  sel.innerHTML += `<option value="${r}">${r}</option>`;
Â  Â  });
Â  Â  sel.onchange = function(){
Â  Â  Â  Â  const r = recipeDB[this.value];
Â  Â  Â  Â  if(r){
Â  Â  Â  Â  Â  Â  document.getElementById('recipeName').value = this.value;
Â  Â  Â  Â  Â  Â  document.getElementById('recipeIngredients').value = r.ingredients;
Â  Â  Â  Â  Â  Â  document.getElementById('recipeProcedure').value = r.procedure;
Â  Â  Â  Â  Â  Â  document.getElementById('recipeCookTime').value = r.cookTime;
Â  Â  Â  Â  Â  Â  document.getElementById('recipeMethod').value = r.method;
Â  Â  Â  Â  Â  Â  document.getElementById('recipeImg').value = r.img;
Â  Â  Â  Â  }
Â  Â  };
Â  Â  document.getElementById('recipeModal').style.display='flex';
}

function saveRecipeForMeal(){
Â  Â  const name = document.getElementById('recipeName').value.trim();
Â  Â  if(!name){ alert("Inserisci un nome per la ricetta"); return; }
Â  Â  recipeDB[name] = {
Â  Â  Â  Â  ingredients: document.getElementById('recipeIngredients').value.trim(),
Â  Â  Â  Â  procedure: document.getElementById('recipeProcedure').value.trim(),
Â  Â  Â  Â  cookTime: document.getElementById('recipeCookTime').value.trim(),
Â  Â  Â  Â  method: document.getElementById('recipeMethod').value.trim(),
Â  Â  Â  Â  img: document.getElementById('recipeImg').value.trim()
Â  Â  };
Â  Â  diary[currentDate][currentMealForRecipe].recipe = name;
Â  Â  closeRecipeModal();
Â  Â  updateMeal(currentMealForRecipe);
Â  Â  autoSaveKawaii();Â 
}

function deleteRecipeForMeal(){
Â  Â  const name = document.getElementById('recipeName').value.trim();
Â  Â  if(name && confirm("Vuoi eliminare questa ricetta?")){
Â  Â  Â  Â  delete recipeDB[name];
Â  Â  Â  Â  // Rimuovi il riferimento alla ricetta dal pasto corrente se corrisponde
Â  Â  Â  Â  if(diary[currentDate][currentMealForRecipe] && diary[currentDate][currentMealForRecipe].recipe === name){
Â  Â  Â  Â  Â  Â  delete diary[currentDate][currentMealForRecipe].recipe;
Â  Â  Â  Â  }
Â  Â  Â  Â  // Rimuovi il riferimento da tutti i pasti nel diario che la usano
Â  Â  Â  Â  Object.keys(diary).forEach(date => {
Â  Â  Â  Â  Â  Â  MEALS.forEach(meal => {
Â  Â  Â  Â  Â  Â  Â  Â  if(diary[date][meal] && diary[date][meal].recipe === name){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  delete diary[date][meal].recipe;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });

Â  Â  Â  Â  closeRecipeModal();
Â  Â  Â  Â  updateMeal(currentMealForRecipe);
Â  Â  Â  Â  autoSaveKawaii();Â 
Â  Â  }
}

function closeRecipeModal(){
Â  Â  document.getElementById('recipeModal').style.display='none';
}

// Mostra tutte le ricette
function showAllRecipes(){
Â  Â  const container = document.getElementById('allRecipesContainer');
Â  Â  container.innerHTML="";
Â  Â  if (Object.keys(recipeDB).length === 0) {
Â  Â  Â  Â  container.innerHTML = "<p>Nessuna ricetta salvata.</p>";
Â  Â  } else {
Â  Â  Â  Â  Object.keys(recipeDB).sort().forEach(r=>{
Â  Â  Â  Â  Â  Â  const rec = recipeDB[r];
Â  Â  Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  Â  Â  div.className="recipeDiv";
Â  Â  Â  Â  Â  Â  div.innerHTML = `<b>${r}</b><br>Ingredienti: ${rec.ingredients.replace(/\n/g, ', ')}<br>Procedimento: ${rec.procedure}<br>â±ï¸ Tempo: ${rec.cookTime}<br>Metodo: ${rec.method}${rec.img?`<br><a href="${rec.img}" target="_blank">ğŸ”— Immagine</a>`:""}`;
Â  Â  Â  Â  Â  Â  container.appendChild(div);
Â  Â  Â  Â  });
Â  Â  }
Â  Â  document.getElementById('allRecipesModal').style.display='flex';
}
function closeAllRecipesModal(){ document.getElementById('allRecipesModal').style.display='none'; }

// --- Tabelle nutrizionali
function showNutritionModal(){
Â  Â  const table = document.getElementById('nutritionTable');
Â  Â  table.innerHTML = `<tr><th>Alimento</th><th>Kcal/100g</th><th>Carbs</th><th>Proteine</th><th>Grassi</th><th>Azioni</th></tr>`;
Â  Â  foodDB.forEach((f,i)=>{
Â  Â  Â  Â  const tr = document.createElement('tr');
Â  Â  Â  Â  tr.innerHTML = `<td>${f.name}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${f.kcal100}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${f.carbs100}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${f.protein100}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${f.fat100}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="editFoodTable(${i})">âœï¸</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="removeFoodTable(${i})">ğŸ—‘ï¸</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>`;
Â  Â  Â  Â  table.appendChild(tr);
Â  Â  });
Â  Â  document.getElementById('nutritionModal').style.display='flex';
}

function editFoodTable(i){
Â  Â  const f = foodDB[i];
Â  Â  const name = prompt("Nome alimento:", f.name);
Â  Â  if(!name) return;
Â  Â  const kcal = parseFloat(prompt("Kcal/100g:", f.kcal100));
Â  Â  const carbs = parseFloat(prompt("Carbs/100g:", f.carbs100));
Â  Â  const protein = parseFloat(prompt("Proteine/100g:", f.protein100));
Â  Â  const fat = parseFloat(prompt("Grassi/100g:", f.fat100));
Â  Â  foodDB[i] = {name, kcal100:kcal, carbs100:carbs, protein100:protein, fat100:fat, img:f.img};
Â  Â  updateFoodList();
Â  Â  showNutritionModal();
Â  Â  autoSaveKawaii();Â 
}

function removeFoodTable(i){
Â  Â  if(confirm("Vuoi eliminare questo alimento?")){
Â  Â  Â  Â  foodDB.splice(i,1);
Â  Â  Â  Â  updateFoodList();
Â  Â  Â  Â  showNutritionModal();
Â  Â  Â  Â  autoSaveKawaii();Â 
Â  Â  }
}
function addNewFood(){
Â  Â  const nameInput = prompt("Nome alimento:");
Â  Â  if(!nameInput) return;
Â  Â  
Â  Â  // ğŸš¨ CORREZIONE: Normalizza il nome (Rimuovi spazi e Capitalizza solo la prima lettera)
    const name = nameInput.trim().charAt(0).toUpperCase() + nameInput.trim().slice(1).toLowerCase();
    
Â  Â  const kcal = parseFloat(prompt("Kcal/100g:"));
Â  Â  const carbs = parseFloat(prompt("Carbs/100g:"));
Â  Â  const protein = parseFloat(prompt("Proteine/100g:"));
Â  Â  const fat = parseFloat(prompt("Grassi/100g:"));
Â  Â  if (isNaN(kcal) || isNaN(carbs) || isNaN(protein) || isNaN(fat)) {
Â  Â  Â  Â  Â alert("Valori nutrizionali non validi. Riprova.");
Â  Â  Â  Â  Â return;
Â  Â  }
Â  Â  // Usa il nome normalizzato
Â  Â  foodDB.push({name,kcal100:kcal,carbs100:carbs,protein100:protein,fat100:fat,img:""});
Â  Â  updateFoodList();
Â  Â  showNutritionModal();
Â  Â  autoSaveKawaii();Â 
Â  Â  alert("ğŸ Nuovo alimento salvato nel database!");
}

function closeNutritionModal(){
Â  Â  document.getElementById('nutritionModal').style.display='none';
Â  Â  updateFoodList();
Â  Â  // ğŸš¨ CORREZIONE: Forza il re-rendering del diario per aggiornare i campi input/datalist
Â  Â  renderDiary(); 
}

// --- Gestione data
function changeDay(date){
Â  Â  currentDate = date;
Â  Â  initDiaryForDate(currentDate);
Â  Â  renderDiary();
}

// --- Sincronizzazione JSONBin (robusta, compatibile iPhone + fallback locale) ---
// La funzione salva sempre localmente prima di provare il cloud
function saveSyncJSONBin() {
Â  Â  initDiaryForDate(currentDate);
Â  Â  const allData = { diary, foodDB, recipeDB, savedAt: new Date().toISOString() };
Â  Â Â 
Â  Â  // 1. Salva localmente sempre
Â  Â  try {
Â  Â  Â  localStorage.setItem("kawaiiAllData", JSON.stringify(allData));
Â  Â  } catch (e) {
Â  Â  Â  console.warn("Impossibile salvare localmente:", e);
Â  Â  }
Â  Â Â 
Â  Â  // 2. Tenta sincronizzazione remota su JSONBin
Â  Â  fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
Â  Â  Â  Â  method: "PUT",
Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  "Content-Type": "application/json",
Â  Â  Â  Â  Â  "X-Master-Key": JSONBIN_MASTER_KEY // Chiave di scrittura
Â  Â  Â  Â  },
Â  Â  Â  Â  body: JSON.stringify(allData)
Â  Â  })
Â  Â  .then(async (res) => {
Â  Â  Â  Â  const text = await res.text();
Â  Â  Â  Â  if (!res.ok) {
Â  Â  Â  Â  Â  throw new Error(`HTTP ${res.status}: ${text}`);
Â  Â  Â  Â  }
Â  Â  Â  Â  alert("âœ… Dati sincronizzati con successo su Cloud!");
Â  Â  Â  Â  console.log("âœ… JSONBin PUT OK:", text);
Â  Â  })
Â  Â  .catch((err) => {
Â  Â  Â  Â  console.error("âŒ Errore sincronizzazione Cloud (PUT):", err);
Â  Â  Â  Â  alert("âš ï¸ Non Ã¨ stato possibile sincronizzare su Cloud. Dati salvati solo localmente come fallback.");
Â  Â  });
}

// La funzione carica da Cloud, se fallisce, carica dal locale
function loadSyncJSONBin(){
Â  Â  // 1. Prova a caricare da JSONBin usando la Read Key (piÃ¹ compatibile)
Â  Â  fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
Â  Â  Â  Â  method: "GET",
Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  "X-Access-Key": JSONBIN_READ_KEY // Chiave di lettura
Â  Â  Â  Â  },
Â  Â  Â  Â  mode: "cors"
Â  Â  })
Â  Â  .then(res => {
Â  Â  Â  Â  if(!res.ok) throw new Error("HTTP " + res.status);
Â  Â  Â  Â  return res.json();
Â  Â  })
Â  Â  .then(data => {
Â  Â  Â  Â  if(!data || !data.record) throw new Error("Record Cloud vuoto");
Â  Â  Â  Â  const rec = data.record;
Â  Â  Â  Â  diary = rec.diary || {};
Â  Â  Â  Â  foodDB = rec.foodDB || [];
Â  Â  Â  Â  recipeDB = rec.recipeDB || {};
Â  Â  Â  Â Â 
Â  Â  Â  Â  initDiaryForDate(currentDate);
Â  Â  Â  Â  updateFoodList();
Â  Â  Â  Â  renderDiary();
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Salva copia locale aggiornata
Â  Â  Â  Â  autoSaveKawaii();Â 
Â  Â  Â  Â  alert("ğŸ“‚ Dati caricati da Cloud!");
Â  Â  })
Â  Â  .catch(err => {
Â  Â  Â  Â  console.warn("âŒ Errore caricamento Cloud (GET):", err);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 2. fallback: prova a caricare da localStorage
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const data = localStorage.getItem("kawaiiAllData");
Â  Â  Â  Â  Â  Â  if(data){
Â  Â  Â  Â  Â  Â  Â  Â  const all = JSON.parse(data);
Â  Â  Â  Â  Â  Â  Â  Â  diary = all.diary || {};
Â  Â  Â  Â  Â  Â  Â  Â  foodDB = all.foodDB || [];
Â  Â  Â  Â  Â  Â  Â  Â  recipeDB = all.recipeDB || {};
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  initDiaryForDate(currentDate);
Â  Â  Â  Â  Â  Â  Â  Â  updateFoodList();
Â  Â  Â  Â  Â  Â  Â  Â  renderDiary();
Â  Â  Â  Â  Â  Â  Â  Â  alert("ğŸ“‚ Cloud non raggiungibile â€” caricati i dati locali come fallback.");
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  alert("âŒ Cloud non raggiungibile e non ci sono dati locali salvati.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch(e){
Â  Â  Â  Â  Â  Â  console.error("Errore fallback locale:", e);
Â  Â  Â  Â  Â  Â  alert("âŒ Errore nel caricamento: controlla console e connessione.");
Â  Â  Â  Â  }
Â  Â  });
}

// --- Avvio
document.addEventListener('DOMContentLoaded', () => {
Â  Â  // Prova a caricare i dati locali salvati come fallback o ultima sessione
Â  Â  try {
Â  Â  Â  Â  const localData = localStorage.getItem("kawaiiAllData");
Â  Â  Â  Â  if (localData) {
Â  Â  Â  Â  Â  Â  const all = JSON.parse(localData);
Â  Â  Â  Â  Â  Â  diary = all.diary || diary;
Â  Â  Â  Â  Â  Â  foodDB = all.foodDB || foodDB;
Â  Â  Â  Â  Â  Â  recipeDB = all.recipeDB || recipeDB;
Â  Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Errore nel caricamento dei dati locali all'avvio:", e);
Â  Â  }
Â  Â Â 
Â  Â  // Imposta la data corrente
Â  Â  document.getElementById('dateInput').value = currentDate;
Â  Â Â 
Â  Â  initDiaryForDate(currentDate);
Â  Â  updateFoodList();
Â  Â  renderDiary();
});
</script>

</body>
</html>




