<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kawaii Diet - Diario Alimentare</title>
    <style>
        /* NUOVI COLORI KAWAII: TUTTO ROSA E MAGENTA */
        :root {
            --kawaii-dark-pink: #ff69b4; /* Rosa accesso per bottoni tondi */
            --kawaii-main-button: #e91e63; /* Magenta acceso per bottoni principali e titoli */
            --kawaii-main-button-hover: #c2185b;
            --main-bg-color: #fff0f5; /* Blush Pink / Sfondo generale */
            --kawaii-shadow: 0 4px 8px rgba(255, 105, 180, 0.2);
            --meal-bg: #ffebee; /* Sfondo pasti leggero */
        }

        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: var(--main-bg-color); /* Sfondo Kawaii */
        }
        h1, h2, h3 { /* Aggiunto h3 per i titoli dei gruppi ricette */
            color: var(--kawaii-main-button); /* Titoli in rosa acceso */
            border-bottom: 2px solid var(--kawaii-dark-pink);
            padding-bottom: 5px;
            margin-top: 20px;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .meal {
            background-color: var(--meal-bg); /* Sfondo Pasto leggermente rosa */
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--kawaii-shadow); /* Ombra rosa */
            border: 1px solid var(--kawaii-dark-pink); /* Bordo sottile rosa */
            flex: 1 1 300px; 
        }
        .item {
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            background-color: #f9f9f9;
            position: relative;
        }
        
        /* STILE BOTTONI AZIONI CIBO (Piccoli, Tondi, Pop) - ROSA */
        .item button.edit-btn, .item button.delete-btn {
            position: absolute;
            background-color: var(--kawaii-dark-pink); 
            color: white;
            border: none;
            cursor: pointer;
            width: 25px; 
            height: 25px; 
            border-radius: 50%; 
            padding: 0;
            line-height: 25px; 
            text-align: center;
            font-size: 12px; 
            box-shadow: 0 2px 5px rgba(255, 105, 180, 0.4);
            transition: background-color 0.2s, transform 0.1s, opacity 0.2s;
            opacity: 0.9; 
        }

        .item button.edit-btn:hover, .item button.delete-btn:hover {
            background-color: #f778a1;
            opacity: 1;
        }
        
        .item button.edit-btn:active, .item button.delete-btn:active {
            transform: scale(0.9);
        }

        /* Posizionamento Bottoni Tondi */
        .item .edit-btn {
            top: 5px; 
            right: 35px; 
        }

        .item .delete-btn {
            top: 5px; 
            right: 5px; 
        }
        /* FINE STILE BOTTONI AZIONI CIBO */


        input[type="text"], input[type="number"], select {
            padding: 8px;
            margin-right: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        /* STILE BOTTONI GENERALI (NON PI√ô VERDI, MA MAGENTA/ROSA) */
        button {
            padding: 8px 12px;
            background-color: var(--kawaii-main-button); /* Colore principale ROSA/MAGENTA */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 2px;
        }
        button:hover {
            background-color: var(--kawaii-main-button-hover);
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .mealTotals, #totals-day {
            margin-top: 10px;
            padding: 10px;
            border-top: 1px solid var(--kawaii-dark-pink);
            font-weight: bold;
            color: #333;
        }
        
        /* Modale di base */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 10000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
            justify-content: center;
            align-items: center;
        }
        .modalContent {
            background-color: var(--main-bg-color);
            margin: auto;
            padding: 20px;
            border: 2px solid var(--kawaii-dark-pink); /* Bordo modale Kawaii */
            width: 80%;
            max-width: 600px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(233, 30, 99, 0.3);
        }
        .modalContent label, .modalContent input, .modalContent textarea, .modalContent select {
            display: block;
            margin-top: 10px;
            width: 95%;
        }
        .modalContent textarea {
            min-height: 80px;
        }
        .recipeDiv {
            border: 2px dashed #ffb6c1; /* Light Pink dashed border */
            padding: 10px;
            margin-top: 10px;
            background-color: #ffeef2; /* Lighter background */
            border-radius: 5px;
        }
        #allRecipesSelect {
            width: 98%;
            margin-bottom: 15px;
        }
        
        /* Stile delle intestazioni di categoria (per Ricette e Alimenti) */
        .category-heading, .recipe-category-heading {
            background-color: var(--kawaii-dark-pink); /* Titoli di gruppo ricette */
            color: white;
            padding: 8px;
            margin-top: 15px;
            margin-bottom: 5px;
            border-radius: 5px;
            font-weight: bold;
            border: 1px solid var(--kawaii-main-button);
        }
        .item-list, .recipe-list {
            padding-left: 10px;
            border-left: 2px solid #add8e6;
            margin-bottom: 10px;
        }
        .item-in-list, .recipe-item-in-list {
            padding: 8px;
            border-bottom: 1px dotted #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .item-in-list:last-child, .recipe-item-in-list:last-child {
            border-bottom: none;
        }

        /* Modale Categorie Ricette (Aggiunta o Modifica) */
        .recipe-category-selector {
            border: 1px solid var(--kawaii-dark-pink);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            background-color: #fff;
        }
        /* Stili per i Bottoni di Selezione */
        .recipe-category-selector button, 
        .all-recipes-button-group button {
            background-color: #ffb6c1; /* Light Pink */
            color: #333;
            border: 1px solid var(--kawaii-dark-pink);
            margin: 5px 5px 5px 0; /* Margine per separare i bottoni */
            padding: 8px 10px;
        }
        .recipe-category-selector button:hover, 
        .all-recipes-button-group button:hover {
             background-color: #ff99aa;
        }
        /* Stile per il bottone selezionato (in entrambe le modali) */
        .recipe-category-selector button.selected,
        .all-recipes-button-group button.selected {
             background-color: var(--kawaii-dark-pink);
             color: white;
             font-weight: bold;
        }

        /* Gruppo pulsanti filtro ricette (Modale "Tutte le ricette") - Non pi√π in uso con la select, ma mantenuto lo stile */
        .all-recipes-button-group {
            margin-top: 10px;
            padding: 5px;
        }
        
        #allRecipesFilterButtons {
            border-bottom: 1px solid var(--kawaii-dark-pink);
            margin-bottom: 5px;
        }
        #allRecipesSubFilterButtons {
            border-bottom: 1px solid #ccc;
            margin-bottom: 15px;
        }

        /* Allineamento Database Alimenti (per renderizzare meglio la lista) */
        #nutritionContent {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        
        .nutrition-item-info {
            flex-grow: 1;
        }
    </style>
</head>
<body>

    <h1>ü•ó Diario Alimentare Kawaii</h1>

    <div class="header-actions">
        <label for="dateInput">Seleziona Data:</label>
        <input type="date" id="dateInput" onchange="changeDay(this.value)">
        <button onclick="saveSyncJSONBin()">‚òÅÔ∏è Salva su Cloud</button>
        <button onclick="loadSyncJSONBin()">‚¨áÔ∏è Carica da Cloud</button>
        <button onclick="showNutritionModal()">‚ûï Database Alimenti</button>
        <button onclick="showAllRecipes()">üìñ Tutte le Ricette</button>
        <button onclick="toggleSportModal()">üèÉ‚Äç‚ôÇÔ∏è Attivit√† Fisica</button>
    </div>

    <div id="totals-day"></div>
    
    <div id="diaryContainer" class="container">
        </div>

    <div id="nutritionModal" class="modal">
        <div class="modalContent">
            <h2>Database Nutrizionale</h2>
            <div id="nutritionContent">
            </div>
            <button style="margin-top: 15px;" onclick="addNewFood()">‚ûï Aggiungi Nuovo Alimento</button>
            <button onclick="closeNutritionModal()">Chiudi</button>
        </div>
    </div>

    <div id="recipeModal" class="modal">
        <div class="modalContent">
            <h2>Gestione Ricetta</h2>

            <select id="existingRecipeSelect" style="margin-bottom: 15px;" onchange="loadRecipeFromSelect()">
                <option value="">--Seleziona ricetta esistente--</option>
            </select>

            <label for="recipeName">Nome Ricetta:</label>
            <input type="text" id="recipeName" placeholder="Es. Torta di Zucca Light">
            
            <div id="recipeCategorySelection" class="recipe-category-selector">
                </div>
            
            <input type="hidden" id="recipeType" value="Altro"> <label for="recipeIngredients">Ingredienti (separati da virgola o a capo):</label>
            <textarea id="recipeIngredients" placeholder="Es. 200g farina, 100g zucchero..."></textarea>
            
            <label for="recipeProcedure">Procedimento:</label>
            <textarea id="recipeProcedure" placeholder="Mescola, inforna, aspetta..."></textarea>

            <label for="recipeCookTime">Tempo di Preparazione/Cottura:</label>
            <input type="text" id="recipeCookTime" placeholder="Es. 45 minuti">

            <label for="recipeMethod">Metodo di Cottura:</label>
            <input type="text" id="recipeMethod" placeholder="Es. Forno statico 180¬∞C">

            <label for="recipeImg">Link Immagine (URL):</label>
            <input type="text" id="recipeImg" placeholder="Link a una foto della ricetta">

            <button style="margin-top: 15px;" onclick="saveRecipeForMeal()">‚úÖ Salva e Assegna/Aggiorna</button>
            <button onclick="deleteRecipeForMeal()">üóëÔ∏è Elimina Ricetta dal Database</button>
            <button onclick="closeRecipeModal()">Annulla</button>
        </div>
    </div>

    <div id="allRecipesModal" class="modal">
        <div class="modalContent">
            <h2>üìñ Tutte le ricette</h2>
            
            <div style="margin-bottom: 15px; border-bottom: 1px solid #ccc; padding-bottom: 10px;">
                <button onclick="insertNewRecipeFromAll()">‚ûï Inserisci Nuova Ricetta</button>
                <button id="editRecipeBtn" onclick="editRecipeFromAll()" disabled>‚úèÔ∏è Modifica Selezionata</button>
                <button id="deleteRecipeBtn" onclick="deleteRecipeFromAll()" disabled>üóëÔ∏è Elimina Selezionata</button>
            </div>

            <label for="allRecipesSelect">Seleziona una ricetta per vederne i dettagli/modificarla:</label>
            <select id="allRecipesSelect" onchange="displaySelectedRecipe()">
                <option value="">-- Nessuna ricetta selezionata --</option>
            </select>

            <div id="recipeDetailContainer" style="margin-top: 15px; margin-bottom: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                Seleziona una ricetta sopra per vederne i dettagli.
            </div>
            
            <div style="margin-bottom: 15px; padding: 10px; border: 1px solid var(--kawaii-dark-pink); border-radius: 5px; background-color: var(--meal-bg);">
                <label>Filtri Ricette (Ricette Nascoste, premi il bottone per mostrarle):</label>
                
                <label for="recipeCategoryFilter" style="font-weight: bold; margin-top: 10px;">Categoria Principale:</label>
                <select id="recipeCategoryFilter" style="width: 100%; margin-bottom: 10px;" onchange="updateSubTypeFilter(this.value)">
                    <option value="">-- Tutte le Categorie --</option>
                    </select>
                
                <div id="subTypeFilterContainer" style="display: none;">
                    <label for="recipeSubTypeFilter" style="font-weight: bold; margin-top: 10px;">Tipo Specifico:</label>
                    <select id="recipeSubTypeFilter" style="width: 100%; margin-bottom: 10px;">
                        <option value="">-- Tutti i Tipi --</option>
                        </select>
                </div>

                <button onclick="filterAllRecipes()">Mostra/Aggiorna Ricette</button>
            </div>
            
            <div id="allRecipesContainer" style="display: none;"> 
                </div>
            
            <button style="margin-top: 20px;" onclick="closeAllRecipesModal()">Chiudi</button>
        </div>
    </div>
    
    <div id="sportModal" class="modal">
        <div class="modalContent">
            <h2>üèÉ‚Äç‚ôÇÔ∏è Attivit√† fisica consigliata</h2>
            <div id="sportContent"></div>
            <button onclick="toggleSportModal()">Chiudi</button>
        </div>
    </div>

    <datalist id="foodList">
        </datalist>

    <script>
        // --- Costanti e variabili
        const MEALS = ["Colazione","Spuntino","Pranzo","Merenda","Cena","Dopocena"];
        
        // STRUTTURA DATI PER LE CATEGORIE RICETTE (Mappa Categoria Principale -> Sottotipi)
        const RECIPE_CATEGORY_MAP = {
            "Primo": ["Avena", "Grano Saraceno", "Mais", "Quinoa", "Miglio"], 
            "Secondo": ["Carni Bianche", "Affettato", "Albume", "Formaggio", "Pesce", "Legumi"],
            "Contorno": ["Zucchine", "Zucca", "Mix", "Fagiolini", "Carciofi", "Rape Rosse", "Spinaci"],
            "Dolce": ["Creme", "Tortino", "Frutta"], 
            "Altro": ["Altro"] 
        };
        
        // Categorie principali per il raggruppamento
        const MAIN_RECIPE_TYPES = Object.keys(RECIPE_CATEGORY_MAP); 

       // CATEGORIE ALIMENTI
const FOOD_CATEGORIES = ["Cereali", "Carne Bianca", "Carne Rossa", "Affettati", "Albume", "Formaggi", "Grassi", "Yogurt", "Dessert", "Frutta", "Verdura", "Altro"];

        const activities = [
            {name:"Tapis roulant", kcalPerMin:10},
            {name:"Ballo Caraibico", kcalPerMin:8},
            {name:"Addominali in palestra", kcalPerMin:7},
            {name:"Passeggiata veloce", kcalPerMin:5},
            {name:"Stretching", kcalPerMin:4},
            {name:"Yoga", kcalPerMin:3}
        ];

        // Dati iniziali 
        let foodDB = [
            {name:"Kiwi", kcal100:49, carbs100:9, protein100:0, fat100:0, img:"", category:"Frutta"},
            {name:"Zucca", kcal100:30, carbs100:6.9, protein100:0, fat100:0, img:"", category:"Verdura"},
            {name:"Fragole", kcal100:30, carbs100:5.3, protein100:0, fat100:0, img:"", category:"Frutta"},
            {name:"Prugne secche", kcal100:65, carbs100:51.2, protein100:0, fat100:0, img:"", category:"Frutta"},
            {name:"Zucchina", kcal100:15, carbs100:0, protein100:0, fat100:0, img:"", category:"Verdura"},
            {name:"Pollo (petto)", kcal100:165, carbs100:0, protein100:31, fat100:3.6, img:"", category:"Proteine Bianche"},
            {name:"Avena", kcal100:389, carbs100:66.3, protein100:16.9, fat100:6.9, img:"", category:"Cereali/Amidi"}
        ];

        let recipeDB = {
            "Pasta di Mais": { 
                ingredients: "Pasta, pesto, pomodorini", 
                procedure: "Cuoci la pasta, condisci con il pesto e aggiungi i pomodorini freschi.", 
                cookTime: "15 minuti", 
                method: "Bollitura",
                type: "Primo: Mais" 
            },
            "Petto di Pollo al Limone": { 
                ingredients: "Petto di pollo, limone, olio, sale", 
                procedure: "Cuoci il pollo in padella, sfuma con il limone.", 
                cookTime: "10 minuti", 
                method: "Padella",
                type: "Secondo: Carni Bianche" 
            },
            "Purea di Zucca": { 
                ingredients: "Zucca, acqua, noce moscata", 
                procedure: "Lessare e frullare.", 
                cookTime: "30 minuti", 
                method: "Bollitura",
                type: "Contorno: Zucca" 
            }
        };

        let diary = {};
        let currentDate = new Date().toISOString().split("T")[0];
        let currentMealForRecipe = null;
        let currentRecipeToEdit = null;

        // Variabili di stato per la modale ricette (Gestione Ricetta)
        let currentRecipeMainType = null;
        let currentRecipeSubType = null;
        
        // --- CONFIGURAZIONE CHIAVI JSONBin (AGGIORNATE CON LE TUE CREDENZIALI)
        const JSONBIN_BIN_ID = "6912f6b1d0ea881f40e14975"; 
        const JSONBIN_MASTER_KEY = "$2a$10$/oqt/konWBpXfYJhVx2EHONSYiQZCSS8PCD7IqU3yPAkckNuE8lP2"; 
        const JSONBIN_READ_KEY = "$2a$10$ClNFWbnoyUzJUFS5AsSv0.PsFdhP3D4PjGFXHiLChKSA9j0.TPakq"; 

        // --- Funzioni di utilit√†
        
        // Helper per estrarre il tipo principale (es. "Primo" da "Primo: Avena")
        function getMainType(type) {
            const parts = type.split(':');
            return parts.length > 1 ? parts[0].trim() : type;
        }
        
        // Helper per estrarre il sottotipo (es. "Avena" da "Primo: Avena")
        function getSubType(type) {
            const parts = type.split(':');
            // Se non c'√® il : prende tutto il tipo (es. "Altro")
            return parts.length > 1 ? parts[1].trim() : type;
        }

        function updateFoodList(){
            const list = document.getElementById('foodList');
            list.innerHTML="";
            foodDB.forEach(f=>{
                const opt = document.createElement('option');
                opt.value = f.name;
                list.appendChild(opt);
            });
        }

        function initDiaryForDate(date){
            if(!diary[date]) diary[date]={};
            MEALS.forEach(m=>{
                if(!diary[date][m]) diary[date][m]=[];
            });
        }

        function renderDiary(){
            const container = document.getElementById('diaryContainer');
            container.innerHTML="";
            MEALS.forEach(meal=>{
                let mealDiv = document.createElement('div');
                mealDiv.className="meal";
                mealDiv.innerHTML = `<h2>${meal}</h2>
                    <input type="text" id="input-${meal}" placeholder="Nome alimento..." list="foodList">
                    <input type="number" id="qty-${meal}" placeholder="Quantit√† (g/ml)" style="width:120px;">
                    <button onclick="addFood('${meal}')">‚ûï Aggiungi alimento</button>
                    <button onclick="insertDefault('${meal}')">üìå Inserisci schema predefinito</button>
                    <div class="itemsContainer" id="items-${meal}"></div>
                    <div class="mealTotals" id="totals-${meal}"></div>
                    <div class="recipeDiv" id="recipe-${meal}"></div>`;
                container.appendChild(mealDiv);
                updateMeal(meal);
            });
            updateDayTotals();
        }

        // --- Funzione di salvataggio locale AUTOMATICO (chiamata ad ogni modifica)
        function autoSaveKawaii(){
            initDiaryForDate(currentDate);
            const allData = { diary, foodDB, recipeDB, savedAt: new Date().toISOString() };
            try {
                localStorage.setItem("kawaiiAllData", JSON.stringify(allData));
            } catch (e) {
                console.warn("Impossibile salvare localmente:", e);
            }
        }

        // --- Alimenti (Logica)
        function addFood(meal){
            const name = document.getElementById(`input-${meal}`).value.trim();
            const qty = parseFloat(document.getElementById(`qty-${meal}`).value);
            if(!name || isNaN(qty) || qty<=0){ alert("Inserisci nome e quantit√† valida"); return; }
            
            const cleanName = name.toLowerCase();
            const f = foodDB.find(x => x.name.toLowerCase() === cleanName);
            
            if(!f){ alert("Alimento non trovato"); return; }
            
            diary[currentDate][meal].push({...f, quantity:qty});
            document.getElementById(`input-${meal}`).value="";
            document.getElementById(`qty-${meal}`).value="";
            updateMeal(meal);
            autoSaveKawaii(); 
        }

        function insertDefault(meal){
            const defaults = {
                "Colazione":[{name:"Kiwi",quantity:80},{name:"Zucca",quantity:66},{name:"Fragole",quantity:100},{name:"Prugne secche",quantity:60}],
                "Pranzo":[{name:"Zucca",quantity:200},{name:"Zucchina",quantity:450}],
                "Cena":[{name:"Zucca",quantity:200},{name:"Zucchina",quantity:450}],
                "Merenda":[{name:"Kiwi",quantity:160},{name:"Fragole",quantity:100}],
                "Dopocena":[{name:"Kiwi",quantity:80},{name:"Fragole",quantity:50}],
                "Spuntino":[{name:"Fragole",quantity:50}]
            };
            defaults[meal].forEach(d=>{
                const f = foodDB.find(x=>x.name===d.name);
                if(f) diary[currentDate][meal].push({...f,quantity:d.quantity,isDefault:true});
            });
            updateMeal(meal);
            autoSaveKawaii(); 
        }

        function editFoodInMeal(meal,index){
            const f = diary[currentDate][meal][index];
            const newQty = parseFloat(prompt(`Quantit√† di ${f.name} (g/ml):`, f.quantity));
            if(!isNaN(newQty) && newQty>0){
                diary[currentDate][meal][index].quantity = newQty;
                updateMeal(meal);
                autoSaveKawaii(); 
            }
        }

        function removeFood(meal,index){
            if(confirm("Vuoi eliminare questo alimento?")){
                diary[currentDate][meal].splice(index,1);
                updateMeal(meal);
                autoSaveKawaii(); 
            }
        }
        
        function updateMeal(meal){
            const container = document.getElementById(`items-${meal}`);
            container.innerHTML="";
            let totalKcal=0, totalCarbs=0, totalProt=0, totalFat=0;
            diary[currentDate][meal].forEach((f,i)=>{
                const kcal = f.kcal100*f.quantity/100;
                const carbs = f.carbs100*f.quantity/100;
                const prot = f.protein100*f.quantity/100;
                const fat = f.fat100*f.quantity/100;
                totalKcal += kcal; totalCarbs += carbs; totalProt += prot; totalFat += fat;
                const div = document.createElement('div');
                div.className="item";
                div.innerHTML = `<b>${f.name}</b><br>üç¥ ${f.quantity}g/ml<br>üî• ${kcal.toFixed(1)} kcal<br>üçû ${carbs.toFixed(1)}g<br>ü•ö ${prot.toFixed(1)}g<br>ü•ë ${fat.toFixed(1)}g
                    <button class="edit-btn" onclick="editFoodInMeal('${meal}',${i})">‚úèÔ∏è</button>
                    <button class="delete-btn" onclick="removeFood('${meal}',${i})">üóëÔ∏è</button>`;
                container.appendChild(div);
            });

            document.getElementById(`totals-${meal}`).innerHTML = `Totale: üî• ${totalKcal.toFixed(1)} kcal | üçû ${totalCarbs.toFixed(1)} g | ü•ö ${totalProt.toFixed(1)} g | ü•ë ${totalFat.toFixed(1)} g`;

            // Ricetta pasto
            const recipeDiv = document.getElementById(`recipe-${meal}`);
            if (diary[currentDate][meal].recipe && recipeDB[diary[currentDate][meal].recipe]) {
                const r = recipeDB[diary[currentDate][meal].recipe];
                const recipeName = diary[currentDate][meal].recipe;

                recipeDiv.innerHTML = `
                    <button onclick="openRecipeModal('${meal}', true)">‚úèÔ∏è Modifica Ricetta</button>
                    <button onclick="deleteRecipeForMeal('${meal}')">üóëÔ∏è Rimuovi Ricetta dal Pasto</button>
                    <br>
                    <b>üìñ ${recipeName}</b> (${getSubType(r.type) || 'N/D'})<br>
                    üç≥ Ingredienti: ${r.ingredients.substring(0, 50)}...<br>
                    üìù Procedimento: ${r.procedure.substring(0, 50)}...<br>
                    ‚è±Ô∏è Tempo: ${r.cookTime}<br>
                    üî• Metodo: ${r.method}
                    ${r.img?`<br><a href="${r.img}" target="_blank">üîó Immagine</a>`:""}`;
            } else {
                // Aggiunta del bottone per la selezione/inserimento quando non c'√® una ricetta
                recipeDiv.innerHTML = `<button onclick="openRecipeModal('${meal}')">üìñ Aggiungi/Seleziona ricetta</button>`;
            }
            updateDayTotals();
        }

function updateDayTotals(){
            let totalKcal=0, totalCarbs=0, totalProt=0, totalFat=0;
            
            // Nuove variabili per il totale escludendo lo schema predefinito
            let customKcal=0, customCarbs=0, customProt=0, customFat=0; 
            
            MEALS.forEach(meal=>{
                if (diary[currentDate][meal]) {
                    diary[currentDate][meal].forEach(f=>{
                        const kcal = f.kcal100*f.quantity/100;
                        const carbs = f.carbs100*f.quantity/100;
                        const prot = f.protein100*f.quantity/100;
                        const fat = f.fat100*f.quantity/100;
                        
                        // Totale Completo
                        totalKcal += kcal; 
                        totalCarbs += carbs; 
                        totalProt += prot; 
                        totalFat += fat;
                        
                        // Totale Personalizzato (esclude isDefault: true)
                        if (!f.isDefault) {
                            customKcal += kcal;
                            customCarbs += carbs;
                            customProt += prot;
                            customFat += fat;
                        }
                    });
                }
            });
            
            // Totale Giornaliero Completo
            let htmlContent = `Totale Giornaliero: üî• ${totalKcal.toFixed(1)} kcal | üçû ${totalCarbs.toFixed(1)} g | ü•ö ${totalProt.toFixed(1)} g | ü•ë ${totalFat.toFixed(1)} g`;
            
            // Totale Giornaliero Escludendo Schema Predefinito (il tuo "Totale Reale")
            htmlContent += `<br><span style="color: var(--kawaii-main-button);">Totale Alimenti Personalizzati:</span> <b>üî• ${customKcal.toFixed(1)} kcal | üçû ${customCarbs.toFixed(1)} g | ü•ö ${customProt.toFixed(1)} g | ü•ë ${customFat.toFixed(1)} g</b>`;

            document.getElementById('totals-day').innerHTML = htmlContent;
        }

        function changeDay(newDate){
            currentDate = newDate;
            initDiaryForDate(currentDate);
            renderDiary();
        }

        // --- JSONBin (Logica)
        async function saveSyncJSONBin(){
            const allData = { diary, foodDB, recipeDB, savedAt: new Date().toISOString() };
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_MASTER_KEY,
                        'X-Bin-Versioning': 'false' 
                    },
                    body: JSON.stringify(allData)
                });
                if(response.ok){
                    alert("‚úÖ Dati salvati con successo sul cloud!");
                    autoSaveKawaii(); 
                } else {
                    const errorText = await response.text();
                    alert(`‚ùå Errore nel salvataggio su cloud. Stato: ${response.status}. Controlla la tua Master Key.`);
                    console.error("Errore salvataggio JSONBin:", response.status, errorText);
                }
            } catch(e){
                alert("‚ùå Errore di connessione al cloud.");
                console.error(e);
            }
        }

        async function loadSyncJSONBin(){
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
                    headers: {
                        // Utilizziamo la Master Key per assicurare tutti i permessi, superando l'errore precedente.
                        'X-Master-Key': JSONBIN_MASTER_KEY 
                    }
                });
                if(response.ok){
                    const data = await response.json();
                    if(data.record){
                        const all = data.record;
                        diary = all.diary || diary;
                        foodDB = all.foodDB || foodDB;
                        recipeDB = all.recipeDB || recipeDB;
                        
                        initDiaryForDate(currentDate);
                        updateFoodList();
                        renderDiary();
                        alert(`‚úÖ Dati caricati dal cloud (salvati il ${new Date(all.savedAt).toLocaleDateString()} alle ${new Date(all.savedAt).toLocaleTimeString()}).`);
                        autoSaveKawaii(); 
                    } else {
                         alert("‚ùå Cloud raggiungibile, ma i dati sono vuoti.");
                    }
                } else {
                    // Se la risposta NON √® ok (es. 401, 403, 404), generiamo un errore per attivare il catch
                    console.error("Errore HTTP nel caricamento cloud:", response.status, await response.text());
                    throw new Error("Cloud non raggiungibile o non autorizzato."); 
                }
            } catch(e){
                // Fallback locale in caso di errore di connessione o errore HTTP 401/403
                console.error("Errore nel caricamento cloud, tentativo di fallback locale:", e);
                const localData = localStorage.getItem("kawaiiAllData");
                if (localData) {
                    const all = JSON.parse(localData);
                    diary = all.diary || diary;
                    foodDB = all.foodDB || foodDB;
                    recipeDB = all.recipeDB || recipeDB;
                    
                    initDiaryForDate(currentDate);
                    updateFoodList();
                    renderDiary();
                    alert("üìÇ Cloud non raggiungibile ‚Äî caricati i dati locali come fallback.");
                } else {
                    alert("‚ùå Cloud non raggiungibile e non ci sono dati locali salvati.");
                }
            }
        }


        // --- Sport (Logica)
        function calculateSport(){
            let totalKcalDay = 0;
            MEALS.forEach(meal=>{
                let kcal=0;
                if (diary[currentDate][meal]) {
                    diary[currentDate][meal].forEach(f=>{
                        kcal += f.kcal100*f.quantity/100;
                    });
                }
                totalKcalDay += kcal;
            });

            const contentDiv = document.getElementById('sportContent');
            if (totalKcalDay > 0) {
                let html = `<b>Totale Calorico Giornaliero:</b> üî• ${totalKcalDay.toFixed(1)} kcal<br>`;
                html += `<b>Tempo Attivit√† Necessario per Bruciarle:</b><br>`;
                activities.forEach(act=>{
                    html += `- ${act.name}: **${Math.ceil(totalKcalDay/act.kcalPerMin)} min** (circa)<br>`;
                });
                contentDiv.innerHTML = html;
            } else {
                contentDiv.innerHTML = `Non ci sono ancora calorie registrate per oggi. Inserisci gli alimenti per vedere i consigli.`;
            }
        }

        function toggleSportModal() {
            calculateSport(); // Ricalcola i totali prima di mostrare
            const modal = document.getElementById('sportModal');
            if (modal.style.display === 'flex') {
                modal.style.display = 'none';
            } else {
                modal.style.display = 'flex';
            }
        }

        // --- Ricette (Logica di selezione con pulsanti - Modale Aggiungi/Modifica)

        function renderRecipeTypeSelection(level, mainType = null) {
            const container = document.getElementById('recipeCategorySelection');
            container.innerHTML = '';
            let html = '';

            if (level === 1) { 
                // Livello 1: Categoria Principale 
                html += '<b>1. Seleziona la Categoria Principale:</b><br>';
                MAIN_RECIPE_TYPES.forEach(type => {
                    const selectedClass = currentRecipeMainType === type ? ' selected' : '';
                    html += `<button class="main-type-btn${selectedClass}" onclick="selectMainType('${type}')">${type}</button>`;
                });
                
                if (!currentRecipeMainType) {
                    document.getElementById('recipeType').value = "Altro";
                }

            } else if (level === 2 && mainType) { 
                // Livello 2: Sottocategoria
                html += `<b>2. Seleziona il Tipo di ${mainType}:</b> `;
                html += `<button onclick="renderRecipeTypeSelection(1)">‚Ü©Ô∏è Indietro</button><br>`;

                const subtypes = RECIPE_CATEGORY_MAP[mainType] || [];
                subtypes.forEach(subType => {
                    const fullType = `${mainType}: ${subType}`;
                    const selectedClass = document.getElementById('recipeType').value === fullType ? ' selected' : '';
                    html += `<button class="sub-type-btn${selectedClass}" onclick="selectSubType('${mainType}', '${subType}')">${subType}</button>`;
                });
            }

            container.innerHTML = html;
        }

        function selectMainType(mainType) {
            currentRecipeMainType = mainType;
            currentRecipeSubType = null;
            
            const subtypes = RECIPE_CATEGORY_MAP[mainType];
            const hasSubtypes = subtypes && subtypes.length > 1; 
            const firstSubType = hasSubtypes ? subtypes[0] : null;

            if (!hasSubtypes || mainType === "Altro" || (subtypes && subtypes.length === 1 && subtypes[0] === mainType)) {
                // Se non ci sono sottotipi o √® "Altro"
                document.getElementById('recipeType').value = mainType;
                currentRecipeSubType = mainType;
                renderRecipeTypeSelection(1); 
            } else {
                // Se ci sono sottotipi, seleziona il primo come predefinito e passa al Livello 2
                selectSubType(mainType, firstSubType); 
                renderRecipeTypeSelection(2, mainType);
            }
        }

        function selectSubType(mainType, subType) {
            currentRecipeSubType = subType;
            const fullType = `${mainType}: ${subType}`;
            document.getElementById('recipeType').value = fullType;
            renderRecipeTypeSelection(2, mainType);
        }

        function openRecipeModal(meal, editExisting = false){
            currentMealForRecipe = meal;
            if (!editExisting && meal === null) {
                currentRecipeToEdit = null;
            }

            // Pulisce i campi e resetta gli stati
            document.getElementById('recipeName').value="";
            document.getElementById('recipeIngredients').value="";
            document.getElementById('recipeProcedure').value="";
            document.getElementById('recipeCookTime').value="";
            document.getElementById('recipeMethod').value="";
            document.getElementById('recipeImg').value="";
            document.getElementById('recipeType').value="Altro";
            currentRecipeMainType = null;
            currentRecipeSubType = null;

            // Riempie il selettore delle ricette esistenti
            const sel = document.getElementById('existingRecipeSelect');
            sel.innerHTML = `<option value="">--Seleziona ricetta esistente--</option>`;
            Object.keys(recipeDB).sort().forEach(r=>{
                sel.innerHTML += `<option value="${r}">${r}</option>`;
            });

            let recipeToLoad = null;

            if (editExisting && diary[currentDate][meal] && diary[currentDate][meal].recipe) {
                recipeToLoad = diary[currentDate][meal].recipe;
                currentRecipeToEdit = recipeToLoad; 
            } else if (currentRecipeToEdit) {
                recipeToLoad = currentRecipeToEdit;
            }

            if (recipeToLoad && recipeDB[recipeToLoad]) {
                const r = recipeDB[recipeToLoad];
                document.getElementById('recipeName').value = recipeToLoad;
                document.getElementById('recipeIngredients').value = r.ingredients;
                document.getElementById('recipeProcedure').value = r.procedure;
                document.getElementById('recipeCookTime').value = r.cookTime;
                document.getElementById('recipeMethod').value = r.method;
                document.getElementById('recipeImg').value = r.img;
                
                const fullType = r.type || "Altro";
                document.getElementById('recipeType').value = fullType;
                currentRecipeMainType = getMainType(fullType);
                currentRecipeSubType = getSubType(fullType);

                sel.value = recipeToLoad;

                // Determina il livello di visualizzazione dei pulsanti
                const subtypes = RECIPE_CATEGORY_MAP[currentRecipeMainType];
                const hasSubtypes = subtypes && subtypes.length > 1; 

                if (hasSubtypes && currentRecipeMainType !== currentRecipeSubType) {
                    renderRecipeTypeSelection(2, currentRecipeMainType);
                } else {
                    renderRecipeTypeSelection(1);
                }
            } else {
                renderRecipeTypeSelection(1);
            }

            document.getElementById('recipeModal').style.display='flex';
        }

        function closeRecipeModal(){
            document.getElementById('recipeModal').style.display='none';
        }

        function loadRecipeFromSelect() {
            const sel = document.getElementById('existingRecipeSelect');
            const recipeName = sel.value;

            // 1. Pulisce tutti i campi (incluso lo stato interno)
            document.getElementById('recipeName').value = "";
            document.getElementById('recipeIngredients').value = "";
            document.getElementById('recipeProcedure').value = "";
            document.getElementById('recipeCookTime').value = "";
            document.getElementById('recipeMethod').value = "";
            document.getElementById('recipeImg').value = "";
            document.getElementById('recipeType').value = "Altro";
            currentRecipeMainType = null;
            currentRecipeSubType = null;
            currentRecipeToEdit = null;
            
            // 2. Carica i dati della ricetta selezionata
            if (recipeName && recipeDB[recipeName]) {
                const r = recipeDB[recipeName];
                
                document.getElementById('recipeName').value = recipeName;
                document.getElementById('recipeIngredients').value = r.ingredients;
                document.getElementById('recipeProcedure').value = r.procedure;
                document.getElementById('recipeCookTime').value = r.cookTime;
                document.getElementById('recipeMethod').value = r.method;
                document.getElementById('recipeImg').value = r.img;
                
                const fullType = r.type || "Altro";
                document.getElementById('recipeType').value = fullType;
                currentRecipeMainType = getMainType(fullType);
                currentRecipeSubType = getSubType(fullType);
                currentRecipeToEdit = recipeName; 
                
                // 3. Ricarica i pulsanti di categoria
                const subtypes = RECIPE_CATEGORY_MAP[currentRecipeMainType];
                const hasSubtypes = subtypes && subtypes.length > 1; 

                if (hasSubtypes && currentRecipeMainType !== currentRecipeSubType) {
                    renderRecipeTypeSelection(2, currentRecipeMainType);
                } else {
                    renderRecipeTypeSelection(1);
                }
            } else {
                renderRecipeTypeSelection(1);
            }
        }

        function saveRecipeForMeal(){
            const name = document.getElementById('recipeName').value.trim();
            if(!name){ alert("Inserisci un nome per la ricetta"); return; }
            
            const recipeType = document.getElementById('recipeType').value;
            const mainType = getMainType(recipeType);
            const subType = getSubType(recipeType);

            if (RECIPE_CATEGORY_MAP[mainType] && RECIPE_CATEGORY_MAP[mainType].length > 1 && subType === mainType) {
                alert("‚ö†Ô∏è Seleziona anche il **Tipo** di ricetta (es. Avena, Mais, ecc.).");
                return;
            }

            if (!recipeType || !MAIN_RECIPE_TYPES.some(type => recipeType.startsWith(type) || recipeType === "Altro")) {
                alert("‚ö†Ô∏è Seleziona la Categoria e il Tipo di ricetta prima di salvare.");
                return;
            }

            recipeDB[name] = {
                ingredients: document.getElementById('recipeIngredients').value.trim(),
                procedure: document.getElementById('recipeProcedure').value.trim(),
                cookTime: document.getElementById('recipeCookTime').value.trim(),
                method: document.getElementById('recipeMethod').value.trim(),
                img: document.getElementById('recipeImg').value.trim(),
                type: recipeType
            };

            if (currentMealForRecipe) {
                diary[currentDate][currentMealForRecipe].recipe = name;
                updateMeal(currentMealForRecipe);
            }

            currentMealForRecipe = null;
            currentRecipeToEdit = null;
            closeRecipeModal();
            
            // Aggiorna la modale di tutte le ricette se √® aperta
            if(document.getElementById('allRecipesModal').style.display === 'flex') {
                showAllRecipes(); 
                // Se la lista era visibile, riapplico il filtro per aggiornarla
                const container = document.getElementById('allRecipesContainer');
                if(container.style.display !== 'none') {
                    filterAllRecipes(); // Chiama la versione senza argomenti che legge dal DOM
                }
            }
            autoSaveKawaii();
        }

        function deleteRecipeForMeal(meal = null){
            const recipeNameInput = document.getElementById('recipeName').value.trim();
            const currentMeal = meal || currentMealForRecipe;
            let nameToDelete = recipeNameInput;

            // Caso 1: Rimuovi riferimento dal Pasto 
            if (meal) {
                nameToDelete = diary[currentDate][meal].recipe;
                if (!nameToDelete) return;

                if(confirm(`Vuoi rimuovere il riferimento alla ricetta '${nameToDelete}' solo dal pasto ${meal}? La ricetta rester√† nel database.`)) {
                    if (diary[currentDate][currentMeal] && diary[currentDate][currentMeal].recipe === nameToDelete) {
                        delete diary[currentDate][currentMeal].recipe;
                    }
                    updateMeal(currentMeal);
                    autoSaveKawaii();
                }
                return;
            }

            // Caso 2: Elimina definitivamente dal Database 
            if (nameToDelete && recipeDB[nameToDelete]) {
                 if(confirm(`Sei sicuro di voler eliminare DEFINITIVAMENTE la ricetta '${nameToDelete}' dal database? Verr√† rimossa da tutti i giorni in cui √® usata.`)) {
                    delete recipeDB[nameToDelete];
                    
                    Object.keys(diary).forEach(date => {
                        MEALS.forEach(m => {
                            if(diary[date][m] && diary[date][m].recipe === nameToDelete){
                                delete diary[date][m].recipe;
                            }
                        });
                    });

                    currentRecipeToEdit = null;
                    closeRecipeModal();
                    updateMeal(currentMealForRecipe); 
                    
                    if(document.getElementById('allRecipesModal').style.display === 'flex') {
                        // Aggiorna la vista della modale
                        showAllRecipes(); 
                    }
                    autoSaveKawaii();
                 }
            } else {
                alert("Nessuna ricetta selezionata per l'eliminazione.");
            }
        }


        // --- Tutte le Ricette (Logica di Filtro e Visualizzazione)
        
        // NUOVA FUNZIONE: Aggiorna il selettore del Tipo Specifico in base alla Categoria Principale
        function updateSubTypeFilter(mainType) {
            const container = document.getElementById('subTypeFilterContainer');
            const subSelect = document.getElementById('recipeSubTypeFilter');
            subSelect.innerHTML = '<option value="">-- Tutti i Tipi --</option>'; 
            subSelect.value = ""; // Resetta il valore

            if (mainType && RECIPE_CATEGORY_MAP[mainType]) {
                const subtypes = RECIPE_CATEGORY_MAP[mainType];
                
                // Se c'√® un solo sottotipo che √® lo stesso del principale (es. "Altro"), nascondi il sotto-filtro
                if (subtypes.length === 1 && subtypes[0] === mainType) {
                     container.style.display = 'none';
                } else {
                    subtypes.forEach(subType => {
                        // Il valore del sotto-filtro √® la stringa completa "Principale: Sottotipo"
                        const fullType = `${mainType}: ${subType}`;
                        subSelect.innerHTML += `<option value="${fullType}">${subType}</option>`;
                    });
                    container.style.display = 'block';
                }
            } else {
                container.style.display = 'none';
            }
        }

        // Funzione per filtrare e renderizzare (chiamata dal bottone)
        function filterAllRecipes() {
            const container = document.getElementById('allRecipesContainer');
            const mainFilter = document.getElementById('recipeCategoryFilter').value;
            const subFilter = document.getElementById('recipeSubTypeFilter').value; // fullType string (es. Primo: Mais)

            container.innerHTML = "";
            
            if (Object.keys(recipeDB).length === 0) {
                container.innerHTML = "<p>Nessuna ricetta salvata. Usa il bottone 'Inserisci Nuova Ricetta'.</p>";
                container.style.display = 'block';
                return;
            }

            // 1. Filtra e raggruppa
            const groupedRecipes = {};
            MAIN_RECIPE_TYPES.forEach(type => {
                // Inizializza i gruppi solo se non c'√® un filtro principale, o se il tipo corrisponde al filtro
                if (!mainFilter || type === mainFilter) {
                     groupedRecipes[type] = [];
                }
            });
            // Assicurati che il gruppo "Altro" esista se non c'√® filtro principale
             if (!mainFilter) groupedRecipes["Altro"] = [];


            Object.keys(recipeDB).forEach(name => {
                const recipe = recipeDB[name];
                const fullType = recipe.type || "Altro";
                const mainType = getMainType(fullType); 
                const groupKey = MAIN_RECIPE_TYPES.includes(mainType) ? mainType : "Altro";
                
                let shouldInclude = true;

                // Filtro 1: Categoria Principale
                if (mainFilter && groupKey !== mainFilter) {
                    shouldInclude = false;
                }

                // Filtro 2: Tipo Specifico (se impostato, deve corrispondere al fullType)
                if (shouldInclude && subFilter && fullType !== subFilter) {
                     shouldInclude = false;
                }

                if (shouldInclude) {
                    // Aggiunge al gruppo. Se il mainFilter √® attivo, aggiunge solo a quel gruppo.
                    if (groupedRecipes[groupKey]) {
                        groupedRecipes[groupKey].push({name, ...recipe});
                    }
                }
            });

            // 2. Renderizza le sezioni
            let htmlContent = '';
            let recipesFound = false;
            
            // Itera sull'ordine dei tipi principali
            MAIN_RECIPE_TYPES.forEach(type => {
                const list = groupedRecipes[type];
                if (list && list.length > 0) {
                    recipesFound = true;
                    
                    // Crea il titolo del gruppo basato sul tipo principale
                    let displayTitle = type;
                    if (type === "Primo") displayTitle = "Primi Piatti (Avena, Mais, Grano Saraceno, ecc.)";
                    else if (type === "Secondo") displayTitle = "Secondi Piatti (Carni, Pesce, Affettati, Legumi, ecc.)";
                    else if (type === "Contorno") displayTitle = "Contorni (Verdure Varie)";
                    else if (type === "Dolce") displayTitle = "Dolci (Creme, Torte, Frutta)";
                    else if (type === "Altro") displayTitle = "Altro";

                    htmlContent += `<h3 class="recipe-category-heading">${displayTitle} (${list.length})</h3>`;
                    htmlContent += `<div class="recipe-list">`;
                    
                    list.sort((a, b) => a.name.localeCompare(b.name)).forEach(r => {
                        const subTypeDisplay = r.type.split(':').slice(-1)[0].trim();
                        
                        htmlContent += `
                            <div class="recipe-item-in-list">
                                <span class="nutrition-item-info">
                                    <b>${r.name}</b> 
                                    <span style="font-size: 0.9em; color: #888;">(${subTypeDisplay})</span>
                                </span>
                                <button onclick="selectRecipeInAll('${r.name.replace(/'/g, "\\'")}')">Seleziona</button>
                            </div>`;
                    });
                    htmlContent += `</div>`;
                }
            });
            
            if (!recipesFound) {
                let filterDisplay = mainFilter || 'Tutte';
                if (subFilter) filterDisplay += ` -> ${getSubType(subFilter)}`;
                htmlContent = `<p>Nessuna ricetta trovata per i filtri selezionati: <b>${filterDisplay}</b>.</p>`;
            }

            container.innerHTML = htmlContent;
            container.style.display = 'block'; // **MOSTRA il container solo dopo il filtro**
        }
        
        // Funzione per preparare la modale (chiamata all'apertura)
        function showAllRecipes(){
            const select = document.getElementById('allRecipesSelect');
            const container = document.getElementById('allRecipesContainer');
            const mainFilterSelect = document.getElementById('recipeCategoryFilter');
            
            // **NASCONDI la lista di ricette inizialmente**
            container.innerHTML = ""; 
            container.style.display = 'none'; 

            // Resetta i campi di selezione
            select.innerHTML = `<option value="">-- Nessuna ricetta selezionata --</option>`;
            document.getElementById('recipeDetailContainer').innerHTML = "Seleziona una ricetta sopra per vederne i dettagli.";
            document.getElementById('editRecipeBtn').disabled = true;
            document.getElementById('deleteRecipeBtn').disabled = true;

            // 1. Popola il Selettore Generale (ricette singole)
            Object.keys(recipeDB).sort().forEach(r=>{
                select.innerHTML += `<option value="${r}">${r}</option>`;
            });
            
            // 2. Popola il selettore Categoria Principale
            const currentMainFilterValue = mainFilterSelect.value;
            mainFilterSelect.innerHTML = '<option value="">-- Tutte le Categorie --</option>';
            MAIN_RECIPE_TYPES.forEach(type => {
                mainFilterSelect.innerHTML += `<option value="${type}" ${type === currentMainFilterValue ? 'selected' : ''}>${type}</option>`;
            });
            
            // 3. Popola il selettore Tipo Specifico e gestisci visibilit√†
            updateSubTypeFilter(mainFilterSelect.value); // Inizializza il sub-filtro

            // Resetta la selezione dell'elenco ricette
            select.value = "";

            document.getElementById('allRecipesModal').style.display='flex';
        }


        function displaySelectedRecipe() {
            const name = document.getElementById('allRecipesSelect').value;
            const container = document.getElementById('recipeDetailContainer');
            document.getElementById('editRecipeBtn').disabled = true;
            document.getElementById('deleteRecipeBtn').disabled = true;

            if (!name) {
                container.innerHTML = "Seleziona una ricetta sopra per vederne i dettagli.";
                return;
            }

            const r = recipeDB[name];
            if (r) {
                container.innerHTML = `
                    <b>Nome:</b> ${name}<br>
                    <b>Categoria:</b> ${r.type || 'N/D'}<br>
                    <b>Ingredienti:</b> ${r.ingredients.replace(/\n/g, '<br>')}<br>
                    <b>Procedimento:</b> ${r.procedure.replace(/\n/g, '<br>')}<br>
                    <b>Tempo:</b> ${r.cookTime}<br>
                    <b>Metodo:</b> ${r.method}<br>
                    ${r.img?`<b>Immagine:</b> <a href="${r.img}" target="_blank">Link</a>`:""}
                `;
                document.getElementById('editRecipeBtn').disabled = false;
                document.getElementById('deleteRecipeBtn').disabled = false;
            }
        }

        function selectRecipeInAll(name) {
             document.getElementById('allRecipesSelect').value = name;
             displaySelectedRecipe();
        }

        function insertNewRecipeFromAll() {
            currentRecipeToEdit = null;
            openRecipeModal(null);
        }

        function editRecipeFromAll() {
            const name = document.getElementById('allRecipesSelect').value;
            if (!name) {
                alert("Seleziona una ricetta prima di modificare.");
                return;
            }
            currentRecipeToEdit = name;
            openRecipeModal(null);
        }

        function deleteRecipeFromAll() {
            const name = document.getElementById('allRecipesSelect').value;
            if (!name) {
                alert("Seleziona una ricetta da eliminare.");
                return;
            }
            if(confirm(`Sei sicuro di voler eliminare DEFINITIVAMENTE la ricetta '${name}' dal database? Verr√† rimossa da tutti i giorni in cui √® usata.`)) {
                delete recipeDB[name];
                Object.keys(diary).forEach(date => {
                    MEALS.forEach(m => {
                        if(diary[date][m] && diary[date][m].recipe === name){
                            delete diary[date][m].recipe;
                        }
                    });
                });
                autoSaveKawaii();
                // Ricarica la vista e applica il filtro corrente
                showAllRecipes();
                filterAllRecipes(); // Chiama la versione senza argomenti
                renderDiary();
            }
        }

        function closeAllRecipesModal(){
            document.getElementById('allRecipesModal').style.display='none';
            renderDiary();
        }

        // --- Tabelle nutrizionali (funzionalit√† categorizzata mantenuta)
        function showNutritionModal(){
            const container = document.getElementById('nutritionContent');
            container.innerHTML = '';

            // 1. Gruppa gli alimenti per categoria
            const groupedFood = {};
            FOOD_CATEGORIES.forEach(cat => {
                groupedFood[cat] = [];
            });
            foodDB.forEach(food => {
                const cat = food.category && FOOD_CATEGORIES.includes(food.category) ? food.category : "Altro";
                groupedFood[cat].push(food);
            });

            // 2. Renderizza le categorie con le sottocartelle
            let htmlContent = '';
            FOOD_CATEGORIES.forEach(category => {
                const list = groupedFood[category];
                if (list && list.length > 0) {
                    htmlContent += `<div class="category-heading">${category} (${list.length})</div>`;
                    htmlContent += `<div class="item-list">`;
                    list.sort((a, b) => a.name.localeCompare(b.name)).forEach((f, i) => {
                        // Trova l'indice corretto nell'array flat foodDB per le azioni
                        const actualIndex = foodDB.findIndex(item => item.name === f.name);
                        htmlContent += `
                            <div class="item-in-list">
                                <div class="nutrition-item-info">
                                    <b>${f.name}</b><br>
                                    Kcal: ${f.kcal100} | Carbs: ${f.carbs100} | Prot: ${f.protein100} | Grassi: ${f.fat100}
                                </div>
                                <div>
                                    <button onclick="editFoodTable(${actualIndex})">‚úèÔ∏è</button>
                                    <button onclick="removeFoodTable(${actualIndex})">üóëÔ∏è</button>
                                </div>
                            </div>`;
                    });
                    htmlContent += `</div>`;
                }
            });

            container.innerHTML = htmlContent;
            document.getElementById('nutritionModal').style.display='flex';
        }

        function closeNutritionModal(){
            document.getElementById('nutritionModal').style.display='none';
        }

        function editFoodTable(i){
    const f = foodDB[i];
    const nameInput = prompt("Nuovo Nome alimento:", f.name);
    if(!nameInput) return;
    const name = nameInput.trim().charAt(0).toUpperCase() + nameInput.trim().slice(1).toLowerCase();
    const kcal = parseFloat(prompt("Nuove Kcal/100g:", f.kcal100));
    const carbs = parseFloat(prompt("Nuovi Carbs/100g:", f.carbs100));
    const protein = parseFloat(prompt("Nuove Proteine/100g:", f.protein100));
    const fat = parseFloat(prompt("Nuovi Grassi/100g:", f.fat100));
    
    if (isNaN(kcal) || isNaN(carbs) || isNaN(protein) || isNaN(fat)) {
        alert("Valori nutrizionali non validi. Riprova.");
        return;
    }

    // --- NUOVA LOGICA DI SELEZIONE DELLA CATEGORIA TRAMITE ELENCO NUMERATO ---
    let category = f.category || "Altro"; // Mantiene il valore attuale
    
    // Trova l'indice predefinito (per mostrare l'opzione corrente)
    const currentCategoryIndex = FOOD_CATEGORIES.indexOf(category);
    
    // Crea un elenco numerato delle categorie per il prompt
    const categoryOptions = FOOD_CATEGORIES.map((cat, index) => {
        const isCurrent = index === currentCategoryIndex;
        return `${index + 1}. ${cat}${isCurrent ? ' (Attuale)' : ''}`;
    }).join('\n');
    
    const categoryPrompt = `Scegli la categoria inserendo il NUMERO corrispondente:\n\n${categoryOptions}\n\n(Lasciare vuoto per mantenere "${category}")`;
    
    const choice = prompt(categoryPrompt);
    
    if (choice) { // Solo se √® stato inserito un valore
        const choiceIndex = parseInt(choice) - 1; 
        
        if (!isNaN(choiceIndex) && choiceIndex >= 0 && choiceIndex < FOOD_CATEGORIES.length) {
            category = FOOD_CATEGORIES[choiceIndex];
        } else {
             alert("Selezione di categoria non valida. Categoria mantenuta.");
        }
    }
    // --- FINE NUOVA LOGICA ---

    if (name !== f.name) {
         Object.keys(diary).forEach(date => {
            MEALS.forEach(m => {
                if(diary[date][m]){
                    diary[date][m].forEach(item => {
                        if(item.name === f.name) {
                            item.name = name;
                        }
                    });
                }
            });
        });
    }

    foodDB[i] = { name, kcal100:kcal, carbs100:carbs, protein100:protein, fat100:fat, img:"", category };
    updateFoodList();
    showNutritionModal();
    renderDiary(); 
    autoSaveKawaii();
}



        function removeFoodTable(i){
            if(confirm(`Sei sicuro di voler eliminare DEFINITIVAMENTE l'alimento '${foodDB[i].name}' dal database e da tutti i pasti?`)) {
                const foodName = foodDB[i].name;
                Object.keys(diary).forEach(date => {
                    MEALS.forEach(m => {
                        if(diary[date][m]){
                            diary[date][m] = diary[date][m].filter(item => item.name !== foodName);
                        }
                    });
                });
                foodDB.splice(i,1);
                updateFoodList();
                showNutritionModal();
                renderDiary(); 
                autoSaveKawaii();
            }
        }



    function addNewFood(){
    const nameInput = prompt("Nome alimento:");
    if(!nameInput) return;
    const name = nameInput.trim().charAt(0).toUpperCase() + nameInput.trim().slice(1).toLowerCase();
    
    const kcal = parseFloat(prompt("Kcal/100g:"));
    const carbs = parseFloat(prompt("Carbs/100g:"));
    const protein = parseFloat(prompt("Proteine/100g:"));
    const fat = parseFloat(prompt("Grassi/100g:"));
    
    if (isNaN(kcal) || isNaN(carbs) || isNaN(protein) || isNaN(fat)) {
        alert("Valori nutrizionali non validi. Riprova.");
        return;
    }

    // --- NUOVA LOGICA DI SELEZIONE DELLA CATEGORIA TRAMITE ELENCO NUMERATO ---
    let category = "Altro"; // Valore predefinito

    // Crea un elenco numerato delle categorie per il prompt
    const categoryOptions = FOOD_CATEGORIES.map((cat, index) => `${index + 1}. ${cat}`).join('\n');
    const categoryPrompt = `Scegli la categoria inserendo il NUMERO corrispondente:\n\n${categoryOptions}\n\n(Premendo Annulla o inserendo un valore non valido verr√† usata la categoria "Altro")`;
    
    const choice = prompt(categoryPrompt);
    
    if (choice) {
        const choiceIndex = parseInt(choice) - 1; // Conversione da numero (base 1) a indice (base 0)
        
        if (!isNaN(choiceIndex) && choiceIndex >= 0 && choiceIndex < FOOD_CATEGORIES.length) {
            category = FOOD_CATEGORIES[choiceIndex];
        }
    }
    // --- FINE NUOVA LOGICA ---

    foodDB.push({ name, kcal100:kcal, carbs100:carbs, protein100:protein, fat100:fat, img:"", category });
    updateFoodList();
    showNutritionModal(); 
    autoSaveKawaii();
}


        // --- Avvio
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const localData = localStorage.getItem("kawaiiAllData");
                if (localData) {
                    const all = JSON.parse(localData);
                    diary = all.diary || diary;
                    foodDB = all.foodDB || foodDB;
                    recipeDB = all.recipeDB || recipeDB;
                }
            } catch (e) {
                console.error("Errore nel caricamento dei dati locali all'avvio:", e);
            }
            
            document.getElementById('dateInput').value = currentDate;
            
            initDiaryForDate(currentDate);
            updateFoodList();
            renderDiary();
        });
    </script>
</body>
</html>

