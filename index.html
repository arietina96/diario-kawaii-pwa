<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kawaii Diet - Diario Alimentare</title>
    <link rel="manifest" href="manifest.json"> 
    <style>
        /* üíñ Nuova palette Cartoon Kawaii */
        :root {
            --kawaii-pink: #F7B6D8; /* Rosa Antico */
            --kawaii-green: #C8E6C9; /* Verde Pastello */
            --kawaii-soft-bg: #FFFCF5; /* Sfondo Crema */
            --kawaii-shadow: #E0A0C0; /* Ombra Rosa Morbida */
            --kawaii-accent: #FF5FA2; /* Fucsia Acceso */
        }
        
        body {
            /* Font cartoonesco */
            font-family: 'Comic Sans MS', cursive, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--kawaii-soft-bg);
            color: #555;
            line-height: 1.6;
        }
        
        h1 {
            color: var(--kawaii-accent); /* Titolo Fucsia */
            border-bottom: 4px dashed var(--kawaii-pink);
            padding-bottom: 10px;
            margin-top: 0;
            text-align: center;
            font-size: 2.2em;
        }
        
        h2 {
            color: var(--kawaii-accent);
            border-bottom: 2px solid var(--kawaii-pink);
            padding-bottom: 5px;
            margin-top: 20px;
            font-size: 1.5em;
        }
        
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            margin-top: 25px;
        }
        
        .meal {
            background-color: #fff;
            padding: 20px;
            border-radius: 25px; /* Bordi molto arrotondati */
            box-shadow: 5px 5px 10px var(--kawaii-shadow); /* Ombra morbida */
            border: 3px solid var(--kawaii-pink); /* Bordo spesso */
            flex: 1 1 320px;
        }

        /* MODIFICA CRITICA: Layout Orizzontale */
        .itemsContainer {
            display: flex;
            flex-wrap: wrap; /* Permette agli elementi di andare a capo su schermi piccoli */
            gap: 15px; /* Spazio tra gli alimenti affiancati */
            margin-top: 15px;
        }
        /* FINE MODIFICA CRITICA */
        
        .item {
            border: 2px dashed var(--kawaii-green);
            padding: 12px;
            /* margin-top rimosso, gestito da gap in itemsContainer */
            border-radius: 15px;
            background-color: #f0fff0; /* Sfondo leggero */
            position: relative;
            /* Rende ogni alimento un blocco compatto */
            flex: 0 0 auto; 
        }

        /* Stile input e select */
        input[type="text"], input[type="number"], select {
            padding: 10px;
            margin-right: 5px;
            border: 2px solid var(--kawaii-pink);
            border-radius: 10px;
            box-shadow: inset 1px 1px 3px rgba(0,0,0,0.1);
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            border-color: var(--kawaii-accent);
        }

        /* Stile pulsanti principali */
        button {
            padding: 10px 15px;
            background-color: var(--kawaii-green);
            color: #333;
            border: 2px solid #66bb66;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s;
            margin: 4px 2px;
            font-weight: bold;
            box-shadow: 2px 2px 0px #66bb66;
        }

        button:hover {
            background-color: #A0D0A0;
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0px #66bb66;
        }
        
        /* Colori specifici per i bottoni Cloud */
        .header-actions button:nth-child(2), /* ‚òÅÔ∏è Salva */
        .header-actions button:nth-child(3) { /* ‚¨áÔ∏è Carica */
            background-color: var(--kawaii-pink); 
            border-color: var(--kawaii-accent);
            box-shadow: 2px 2px 0px var(--kawaii-accent);
        }
        .header-actions button:nth-child(2):hover,
        .header-actions button:nth-child(3):hover {
            background-color: #EFA0C0;
            box-shadow: 1px 1px 0px var(--kawaii-accent);
        }

        .item button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            padding: 0;
            margin: 0;
            box-shadow: none;
            position: absolute; /* Posizionamento assoluto per i bottoni nell'item */
        }
        .item button:hover {
            opacity: 0.7;
            transform: none;
        }
        .item button:nth-child(2) { /* Edit button */
            right: 40px;
        }
        /* Bottoni modifica/elimina all'interno dell'item */
        .item button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            padding: 0;
            margin: 0;
            box-shadow: none;
            position: absolute; 
            top: 2px; 
            right: 10px;
        }
        .item button:nth-child(1) { /* Edit button (primo bottone) */
            right: 40px;
        }


        .mealTotals, #totals-day {
            margin-top: 15px;
            padding: 15px;
            border-top: 3px dashed var(--kawaii-green);
            font-weight: bold;
            color: #333;
            background-color: #f0fff0;
            border-radius: 10px;
        }
        
        /* Bottone flottante */
        #floating-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--kawaii-accent); /* Fucsia */
            color: white;
            border: 4px solid var(--kawaii-pink);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.5em;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 1000;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .header-actions {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background-color: var(--kawaii-green);
            border-radius: 20px;
            border: 3px solid #66bb66;
            box-shadow: 3px 3px 6px #A0D0A0;
        }
        /* Modale */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 10000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(247, 182, 216, 0.6); /* Sfondo rosa traslucido */
            justify-content: center;
            align-items: center;
        }
        .modalContent {
            background-color: #fff;
            padding: 25px;
            border: 4px dashed var(--kawaii-accent);
            width: 90%;
            max-width: 650px;
            border-radius: 30px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        /* Stile ricetta */
        .recipeDiv {
            border: 2px solid var(--kawaii-accent);
            background-color: #ffefff;
            padding: 15px;
            margin-top: 15px;
            border-radius: 15px;
            box-shadow: 1px 1px 5px rgba(0,0,0,0.1);
        }
        .recipe-category-heading {
            background-color: var(--kawaii-green);
            color: #333;
            padding: 10px;
            margin-top: 15px;
            margin-bottom: 5px;
            border-radius: 15px;
            font-weight: bold;
            cursor: pointer;
            border: 2px solid #66bb66;
            box-shadow: 2px 2px 0px #66bb66;
        }
        .recipe-list {
            padding-left: 10px;
            border-left: 2px solid var(--kawaii-green);
            margin-bottom: 10px;
        }
        .recipe-item-in-list {
            padding: 8px;
            border-bottom: 1px dotted var(--kawaii-pink);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .recipe-item-in-list:last-child {
            border-bottom: none;
        }
        /* Stile per i dati nello sport div (flottante) */
        .sportDiv {
            position: fixed;
            bottom: 20px;
            left: 20px; /* Spostato a sinistra per non coprire il bottone flottante */
            background-color: #fff0f5; /* Rosa chiaro */
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 8px var(--kawaii-shadow);
            border: 3px solid var(--kawaii-pink);
            z-index: 1000;
            max-width: 250px;
        }
    </style>
</head>
<body>

    <h1>üíñ Diario Alimentare ‚ú® Kawaii üéÄ</h1>

    <div class="header-actions">
        <label for="dateInput">üìÖ Data:</label>
        <input type="date" id="dateInput" onchange="changeDay(this.value)">
        <button onclick="saveSyncJSONBin()">‚òÅÔ∏è Salva su Cloud</button>
        <button onclick="loadSyncJSONBin()">‚¨áÔ∏è Carica da Cloud</button>
        <button onclick="showNutritionModal()">‚ûï Database üçé</button>
        <button onclick="showAllRecipes()">üìñ Ricette üç∞</button>
    </div>

    <div id="totals-day"></div>
    
    <div id="diaryContainer" class="container">
        </div>

    <button id="floating-btn" onclick="showSportModal()">üèÉ‚Äç‚ôÄÔ∏è</button>

    <div id="sportModal" class="modal">
        <div class="modalContent">
            <h2>üèÉ‚Äç‚ôÄÔ∏è Attivit√† Fisica & Calorie Giornaliere</h2>
            <div id="sportContent">
                </div>
            <button style="margin-top: 15px;" onclick="closeSportModal()">Chiudi</button>
        </div>
    </div>
    
    <div id="nutritionModal" class="modal">
        <div class="modalContent">
            <h2>Database Nutrizionale</h2>
            <table id="nutritionTable" style="width:100%; border-collapse: collapse;">
                </table>
            <button style="margin-top: 15px;" onclick="addNewFood()">‚ûï Aggiungi Nuovo Alimento</button>
            <button onclick="closeNutritionModal()">Chiudi</button>
        </div>
    </div>

    <div id="recipeModal" class="modal">
        <div class="modalContent">
            <h2>Gestione Ricetta</h2>

            <select id="existingRecipeSelect" style="margin-bottom: 15px;">
                <option value="">--Seleziona ricetta esistente--</option>
            </select>

            <label for="recipeName">Nome Ricetta:</label>
            <input type="text" id="recipeName" placeholder="Es. Torta di Zucca Light">
            
            <label for="recipeType">Tipo di Ricetta:</label>
            <select id="recipeType">
                <option value="Primo">Primo Piatto</option>
                <option value="Secondo">Secondo Piatto</option>
                <option value="Dolce">Dolce</option>
                <option value="Contorno">Contorno</option>
                <option value="Altro">Altro</option>
            </select>
            
            <label for="recipeIngredients">Ingredienti (separati da virgola o a capo):</label>
            <textarea id="recipeIngredients" placeholder="Es. 200g farina, 100g zucchero..."></textarea>
            
            <label for="recipeProcedure">Procedimento:</label>
            <textarea id="recipeProcedure" placeholder="Mescola, inforna, aspetta..."></textarea>

            <label for="recipeCookTime">Tempo di Preparazione/Cottura:</label>
            <input type="text" id="recipeCookTime" placeholder="Es. 45 minuti">

            <label for="recipeMethod">Metodo di Cottura:</label>
            <input type="text" id="recipeMethod" placeholder="Es. Forno statico 180¬∞C">

            <label for="recipeImg">Link Immagine (URL):</label>
            <input type="text" id="recipeImg" placeholder="Link a una foto della ricetta">

            <button style="margin-top: 15px;" onclick="saveRecipeForMeal()">‚úÖ Salva e Assegna/Aggiorna</button>
            <button onclick="deleteRecipeForMeal()">üóëÔ∏è Elimina Ricetta dal Database</button>
            <button onclick="closeRecipeModal()">Annulla</button>
        </div>
    </div>

    <div id="allRecipesModal" class="modal">
        <div class="modalContent">
            <h2>üìñ Tutte le ricette</h2>
            
            <div style="margin-bottom: 15px; border-bottom: 1px solid #ccc; padding-bottom: 10px;">
                <button onclick="insertNewRecipeFromAll()">‚ûï Inserisci Nuova Ricetta</button>
                <button id="editRecipeBtn" onclick="editRecipeFromAll()" disabled>‚úèÔ∏è Modifica Selezionata</button>
                <button id="deleteRecipeBtn" onclick="deleteRecipeFromAll()" disabled>üóëÔ∏è Elimina Selezionata</button>
            </div>

            <label for="allRecipesSelect">Seleziona una ricetta per vedere i dettagli/modificarla:</label>
            <select id="allRecipesSelect" onchange="displaySelectedRecipe()">
                <option value="">-- Nessuna ricetta selezionata --</option>
            </select>

            <div id="recipeDetailContainer" style="margin-top: 15px; margin-bottom: 20px; padding: 10px; border: 1px solid var(--kawaii-pink); border-radius: 5px; background-color: #fff5fa;">
                Seleziona una ricetta sopra per vederne i dettagli.
            </div>

            <div id="allRecipesContainer">
                </div>
            
            <button style="margin-top: 20px;" onclick="closeAllRecipesModal()">Chiudi</button>
        </div>
    </div>

    <datalist id="foodList">
        </datalist>

    <script>
        // --- Costanti e variabili
        const MEALS = ["Colazione","Spuntino","Pranzo","Merenda","Cena","Dopocena"];
        const RECIPE_TYPES = ["Primo", "Secondo", "Dolce", "Contorno", "Altro"]; 
        const activities = [
            {name:"Tapis roulant", kcalPerMin:10},
            {name:"Ballo Caraibico", kcalPerMin:8},
            {name:"Addominali in palestra", kcalPerMin:7},
            {name:"Passeggiata veloce", kcalPerMin:5},
            {name:"Stretching", kcalPerMin:4},
            {name:"Yoga", kcalPerMin:3}
        ];

        // Dati iniziali (saranno sovrascritti dal localStorage o JSONBin)
        let foodDB = [
            {name:"Kiwi", kcal100:49, carbs100:9, protein100:0.8, fat100:0.4, img:""},
            {name:"Zucca", kcal100:30, carbs100:6.9, protein100:1.1, fat100:0.1, img:""},
            {name:"Fragole", kcal100:30, carbs100:5.3, protein100:0.7, fat100:0.4, img:""},
            {name:"Prugne secche", kcal100:240, carbs100:51.2, protein100:2.2, fat100:0.4, img:""},
            {name:"Zucchina", kcal100:15, carbs100:3.1, protein100:1.2, fat100:0.1, img:""}
        ];

        let recipeDB = {
            "Pasta al Pesto Leggero": { 
                ingredients: "Pasta integrale (80g), Pesto Light (20g), Pomodorini (50g)", 
                procedure: "Cuoci la pasta, condisci con il pesto e aggiungi i pomodorini freschi.", 
                cookTime: "15 minuti", 
                method: "Bollitura",
                type: "Primo" 
            },
            "Petto di Pollo al Limone": { 
                ingredients: "Petto di pollo (150g), Limone, Olio (5g), Sale", 
                procedure: "Cuoci il pollo in padella, sfuma con il limone.", 
                cookTime: "10 minuti", 
                method: "Padella",
                type: "Secondo" 
            }
        };

        let diary = {};
        let currentDate = new Date().toISOString().split("T")[0];
        let currentMealForRecipe = null;
        let currentRecipeToEdit = null;

        // --- CONFIGURAZIONE CHIAVI JSONBin (Mantenute le chiavi precedenti) ---
        const JSONBIN_BIN_ID = "6912f6b1d0ea881f40e14975"; 
        const JSONBIN_MASTER_KEY = "$2a$10$/oqt/konWBpXfYJhVx2EHONSYiQZCSS8PCD7IqU3yPAkckNuE8lP2"; 
        const JSONBIN_READ_KEY = "$2a$10$ClNFWbnoyUzJUFS5AsSv0.PsFdhP3D4PjGFXHiLChKSA9j0.TPakq"; 


        // --- Funzioni di utilit√†
        function updateFoodList(){
            const list = document.getElementById('foodList');
            list.innerHTML="";
            foodDB.forEach(f=>{
                const opt = document.createElement('option');
                opt.value = f.name;
                list.appendChild(opt);
            });
        }

        function initDiaryForDate(date){
            if(!diary[date]) diary[date]={};
            MEALS.forEach(m=>{
                if(!diary[date][m]) diary[date][m]=[];
            });
            // Assicurati che il div per l'attivit√† fisica sia sempre chiuso all'avvio
            const sportDiv = document.querySelector('.sportDiv');
            if (sportDiv) sportDiv.remove();
        }

        function renderDiary(){
            const container = document.getElementById('diaryContainer');
            container.innerHTML="";
            MEALS.forEach(meal=>{
                let mealDiv = document.createElement('div');
                mealDiv.className="meal";
                mealDiv.innerHTML = `<h2>${meal}</h2>
                    <input type="text" id="input-${meal}" placeholder="Nome alimento..." list="foodList">
                    <input type="number" id="qty-${meal}" placeholder="Quantit√† (g/ml)" style="width:120px;">
                    <button onclick="addFood('${meal}')">‚ûï Aggiungi alimento</button>
                    <button onclick="insertDefault('${meal}')">üìå Inserisci schema predefinito</button>
                    <div class="itemsContainer" id="items-${meal}"></div>
                    <div class="mealTotals" id="totals-${meal}"></div>
                    <div class="recipeDiv" id="recipe-${meal}"></div>`;
                container.appendChild(mealDiv);
                updateMeal(meal);
            });
            updateDayTotals();
            showSport();
        }

        // --- Funzione di salvataggio locale AUTOMATICO (chiamata ad ogni modifica)
        function autoSaveKawaii(){
            initDiaryForDate(currentDate);
            const allData = { diary, foodDB, recipeDB, savedAt: new Date().toISOString() };
            try {
                localStorage.setItem("kawaiiAllData", JSON.stringify(allData));
            } catch (e) {
                console.warn("Impossibile salvare localmente:", e);
            }
        }

        // --- Alimenti
        function addFood(meal){
            const name = document.getElementById(`input-${meal}`).value.trim();
            const qty = parseFloat(document.getElementById(`qty-${meal}`).value);
            if(!name || isNaN(qty) || qty<=0){ alert("Inserisci nome e quantit√† valida"); return; }
            
            // Normalizza e cerca
            const cleanName = name.trim().charAt(0).toUpperCase() + name.trim().slice(1).toLowerCase();
            const f = foodDB.find(x => x.name === cleanName);
            
            if(!f){ alert(`Alimento "${cleanName}" non trovato. Aggiungilo al database.`); return; }
            
            diary[currentDate][meal].push({...f, quantity:qty, isDefault:false}); // isDefault:false per gli alimenti aggiunti manualmente
            document.getElementById(`input-${meal}`).value="";
            document.getElementById(`qty-${meal}`).value="";
            updateMeal(meal);
            autoSaveKawaii(); 
        }

        function insertDefault(meal){
            // Normalizza i nomi degli alimenti nel defaults per trovare i match corretti nel foodDB
            const defaults = {
                "Colazione":[{name:"Kiwi",quantity:80},{name:"Zucca",quantity:66},{name:"Fragole",quantity:100},{name:"Prugne secche",quantity:60}],
                "Pranzo":[{name:"Zucca",quantity:200},{name:"Zucchina",quantity:450}],
                "Cena":[{name:"Zucca",quantity:200},{name:"Zucchina",quantity:450}],
                "Merenda":[{name:"Kiwi",quantity:160},{name:"Fragole",quantity:100}],
                "Dopocena":[{name:"Kiwi",quantity:80},{name:"Fragole",quantity:50}],
                "Spuntino":[{name:"Fragole",quantity:50}]
            };
            
            if (!defaults[meal]) return;
            
            defaults[meal].forEach(d=>{
                const f = foodDB.find(x=>x.name===d.name);
                if(f) {
                    // Controlla se l'alimento √® gi√† presente nello schema (per evitare duplicati se si clicca pi√π volte)
                    const alreadyExists = diary[currentDate][meal].some(item => item.name === d.name && item.isDefault);
                    if (!alreadyExists) {
                        diary[currentDate][meal].push({...f,quantity:d.quantity,isDefault:true});
                    }
                }
            });
            updateMeal(meal);
            autoSaveKawaii(); 
        }

        function editFoodInMeal(meal,index){
            const f = diary[currentDate][meal][index];
            const newQty = parseFloat(prompt(`Quantit√† di ${f.name} (g/ml):`, f.quantity));
            if(!isNaN(newQty) && newQty>0){
                diary[currentDate][meal][index].quantity = newQty;
                updateMeal(meal);
                autoSaveKawaii(); 
            }
        }

        function removeFood(meal,index){
            if(confirm("Vuoi eliminare questo alimento?")){
                diary[currentDate][meal].splice(index,1);
                updateMeal(meal);
                autoSaveKawaii(); 
            }
        }

        function updateMeal(meal){
            const container = document.getElementById(`items-${meal}`);
            container.innerHTML="";
            let totalKcal=0, totalCarbs=0, totalProt=0, totalFat=0;
            diary[currentDate][meal].forEach((f,i)=>{
                const kcal = f.kcal100*f.quantity/100;
                const carbs = f.carbs100*f.quantity/100;
                const prot = f.protein100*f.quantity/100;
                const fat = f.fat100*f.quantity/100;
                totalKcal += kcal; totalCarbs += carbs; totalProt += prot; totalFat += fat;
                const div = document.createElement('div');
                div.className="item";

                // Aggiunto l'icona per distinguere gli elementi dello schema
                const isDefaultTag = f.isDefault ? 'üìå ' : 'üç¥ '; 

                // Struttura in colonna (verticale) all'interno del riquadro dell'alimento
                div.innerHTML = `
                    <b>${isDefaultTag} ${f.name}</b>
                    <br>Quantit√†: ${f.quantity}g/ml
                    <br>Kcal: ${kcal.toFixed(1)}
                    <br>Carbs: ${carbs.toFixed(1)}g
                    <br>Prot: ${prot.toFixed(1)}g
                    <br>Grassi: ${fat.toFixed(1)}g
                    <button onclick="removeFood('${meal}',${i})">üóëÔ∏è</button>
                    <button onclick="editFoodInMeal('${meal}',${i})">‚úèÔ∏è</button>
                `;
                container.appendChild(div);
            });

            document.getElementById(`totals-${meal}`).innerHTML = `Totale: üî• ${totalKcal.toFixed(1)} kcal | üçû ${totalCarbs.toFixed(1)} g | ü•ö ${totalProt.toFixed(1)} g | ü•ë ${totalFat.toFixed(1)} g`;

            // Ricetta pasto
            const recipeDiv = document.getElementById(`recipe-${meal}`);
            if(diary[currentDate][meal].recipe && recipeDB[diary[currentDate][meal].recipe]){
                const r = recipeDB[diary[currentDate][meal].recipe];
                const recipeName = diary[currentDate][meal].recipe;

                recipeDiv.innerHTML = `
                    <button onclick="openRecipeModal('${meal}', true)">‚úèÔ∏è Modifica Ricetta</button>
                    <button onclick="deleteRecipeForMeal('${meal}')">üóëÔ∏è Rimuovi Ricetta dal Pasto</button>
                    <br>
                    <b>üìñ ${recipeName}</b> (${r.type || 'N/D'})<br>
                    üç≥ Ingredienti: ${r.ingredients}<br>
                    üìù Procedimento: ${r.procedure}<br>
                    ‚è±Ô∏è Tempo: ${r.cookTime}<br>
                    üî• Metodo: ${r.method}
                    ${r.img?`<br><a href="${r.img}" target="_blank">üîó Immagine</a>`:""}`;
            } else {
                // Aggiunta del bottone per la selezione/inserimento quando non c'√® una ricetta
                recipeDiv.innerHTML = `<button onclick="openRecipeModal('${meal}')">üìñ Aggiungi/Seleziona ricetta</button>`;
            }
            updateDayTotals();
        }

        function updateDayTotals(){
            let totalKcal=0, totalCarbs=0, totalProt=0, totalFat=0;
            let selKcal=0, selCarbs=0, selProt=0, selFat=0; // Totali non-schema
            
            MEALS.forEach(meal=>{
                if (diary[currentDate][meal]) {
                    diary[currentDate][meal].forEach(f=>{
                        const kcal = f.kcal100*f.quantity/100;
                        const carbs = f.carbs100*f.quantity/100;
                        const prot = f.protein100*f.quantity/100;
                        const fat = f.fat100*f.quantity/100;
                        totalKcal += kcal; totalCarbs += carbs; totalProt += prot; totalFat += fat;
                        
                        // Calcola i totali solo per gli alimenti Aggiunti Manualmente (non schema)
                        if(!f.isDefault){ 
                             selKcal += kcal; 
                             selCarbs += carbs; 
                             selProt += prot; 
                             selFat += fat; 
                        }
                    });
                }
            });
            document.getElementById('totals-day').innerHTML = `<b>Totale giornata (Schema + Manuale):</b> üî• ${totalKcal.toFixed(1)} kcal | üçû ${totalCarbs.toFixed(1)} g | ü•ö ${totalProt.toFixed(1)} g | ü•ë ${totalFat.toFixed(1)} g<br><b>Totale Alimentazione Manuale:</b> üî• ${selKcal.toFixed(1)} kcal | üçû ${selCarbs.toFixed(1)} g | ü•ö ${selProt.toFixed(1)} g | ü•ë ${selFat.toFixed(1)} g`;
        }

        // --- Sport
        function showSport(){
            const existing = document.querySelector('.sportDiv');
            if(existing) existing.remove();
            
            const div = document.createElement('div');
            div.className="sportDiv";
            
            let totalKcalDay = 0;
            MEALS.forEach(meal=>{
                let kcal=0;
                if (diary[currentDate][meal]) {
                    diary[currentDate][meal].forEach(f=>{ kcal += f.kcal100*f.quantity/100; });
                }
                totalKcalDay += kcal;
            });
            
            if (totalKcalDay > 0) {
                div.innerHTML = `<b>üèÉ‚Äç‚ôÄÔ∏è Totale Calorico Giornaliero:</b> üî• ${totalKcalDay.toFixed(1)} kcal<br><br>`;
                div.innerHTML += `<b>Tempo Attivit√† Suggerito:</b><br>`;
                activities.forEach(act=>{
                    div.innerHTML += `- ${act.name}: <b>${Math.ceil(totalKcalDay/act.kcalPerMin)} min</b><br>`;
                });
            } else {
                div.innerHTML = `üèÉ‚Äç‚ôÄÔ∏è Non ci sono ancora calorie registrate per oggi.`;
            }

            document.body.appendChild(div);
        }
        
        // Simulo la chiusura della modale (anche se il div sport √® flottante)
        function closeSportModal() {
            // Se la modale fosse stata usata, qui ci sarebbe il codice per chiuderla.
            // Per il momento √® un placeholder per coerenza.
            document.getElementById('sportModal').style.display='none';
        }
        function showSportModal() {
            // Il contenuto √® gi√† visibile nel div flottante, ma puoi usare questa funzione per mostrare la modale se preferisci
            // document.getElementById('sportModal').style.display='flex';
            alert("Il riepilogo attivit√† fisica √® visibile nel riquadro flottante in basso a sinistra.");
        }


        // --- Ricette (Gestione Dettaglio Pasto)
        function openRecipeModal(meal, editExisting = false){
            currentMealForRecipe = meal;
            currentRecipeToEdit = null; 

            // Pulisce i campi e imposta il tipo di default
            document.getElementById('recipeName').value="";
            document.getElementById('recipeIngredients').value="";
            document.getElementById('recipeProcedure').value="";
            document.getElementById('recipeCookTime').value="";
            document.getElementById('recipeMethod').value="";
            document.getElementById('recipeImg').value="";
            document.getElementById('recipeType').value="Primo"; // Imposta default

            // Riempie il selettore delle ricette esistenti
            const sel = document.getElementById('existingRecipeSelect');
            sel.innerHTML = `<option value="">--Seleziona ricetta esistente--</option>`;
            Object.keys(recipeDB).sort().forEach(r=>{
                // Aggiunge anche il tipo nel dropdown per chiarezza
                sel.innerHTML += `<option value="${r}">${r} (${recipeDB[r].type || 'Altro'})</option>`;
            });
            
            // LOGICA DI PRECOMPILAZIONE PER LA MODIFICA
            let recipeToLoad = null;

            if (editExisting && diary[currentDate][meal] && diary[currentDate][meal].recipe) {
                recipeToLoad = diary[currentDate][meal].recipe;
            } else if (currentRecipeToEdit) {
                recipeToLoad = currentRecipeToEdit;
            }

            if (recipeToLoad && recipeDB[recipeToLoad]) {
                const r = recipeDB[recipeToLoad];
                document.getElementById('recipeName').value = recipeToLoad;
                document.getElementById('recipeIngredients').value = r.ingredients;
                document.getElementById('recipeProcedure').value = r.procedure;
                document.getElementById('recipeCookTime').value = r.cookTime;
                document.getElementById('recipeMethod').value = r.method;
                document.getElementById('recipeImg').value = r.img;
                document.getElementById('recipeType').value = r.type || "Altro"; 
                sel.value = recipeToLoad;
            }

            // Funzione per precompilare i campi quando si seleziona una ricetta dal select
            sel.onchange = function(){
                const name = this.value;
                const r = recipeDB[name];
                if(r){
                    document.getElementById('recipeName').value = name;
                    document.getElementById('recipeIngredients').value = r.ingredients;
                    document.getElementById('recipeProcedure').value = r.procedure;
                    document.getElementById('recipeCookTime').value = r.cookTime;
                    document.getElementById('recipeMethod').value = r.method;
                    document.getElementById('recipeImg').value = r.img;
                    document.getElementById('recipeType').value = r.type || "Altro"; 
                } else {
                    // Pulisci se selezionato "--Seleziona ricetta esistente--"
                    document.getElementById('recipeName').value = "";
                    document.getElementById('recipeIngredients').value = "";
                    document.getElementById('recipeProcedure').value = "";
                    document.getElementById('recipeCookTime').value = "";
                    document.getElementById('recipeMethod').value = "";
                    document.getElementById('recipeImg').value = "";
                    document.getElementById('recipeType').value = "Primo";
                }
            };

            document.getElementById('recipeModal').style.display='flex';
        }

        function saveRecipeForMeal(){
            const name = document.getElementById('recipeName').value.trim();
            if(!name){ alert("Inserisci un nome per la ricetta"); return; }
            
            const oldName = document.getElementById('existingRecipeSelect').value;

            // Se il nome della ricetta √® cambiato, assicurati che la vecchia ricetta sia eliminata dal database
            if (currentRecipeToEdit && name !== currentRecipeToEdit) {
                if(confirm(`Hai rinominato la ricetta da '${currentRecipeToEdit}' a '${name}'. Vuoi eliminare la vecchia versione dal database?`)) {
                    delete recipeDB[currentRecipeToEdit];
                    // Aggiorna tutti i riferimenti nel diario
                     Object.keys(diary).forEach(date => {
                        MEALS.forEach(m => {
                            if(diary[date][m] && diary[date][m].recipe === currentRecipeToEdit){
                                diary[date][m].recipe = name;
                            }
                        });
                    });
                } else {
                    // Se l'utente non vuole eliminare la vecchia, la nuova ricetta sar√† salvata con il nuovo nome
                    // e la vecchia rimarr√† nel DB (e nei pasti precedenti).
                }
            } else if (oldName && name !== oldName) {
                 // Caso in cui si √® selezionato un elemento esistente e si √® cambiato il nome
                 if(confirm(`Hai rinominato la ricetta da '${oldName}' a '${name}'. Vuoi eliminare la vecchia versione dal database?`)) {
                    delete recipeDB[oldName];
                     // Aggiorna tutti i riferimenti nel diario
                     Object.keys(diary).forEach(date => {
                        MEALS.forEach(m => {
                            if(diary[date][m] && diary[date][m].recipe === oldName){
                                diary[date][m].recipe = name;
                            }
                        });
                    });
                }
            }


            const recipeType = document.getElementById('recipeType').value;

            recipeDB[name] = {
                ingredients: document.getElementById('recipeIngredients').value.trim(),
                procedure: document.getElementById('recipeProcedure').value.trim(),
                cookTime: document.getElementById('recipeCookTime').value.trim(),
                method: document.getElementById('recipeMethod').value.trim(),
                img: document.getElementById('recipeImg').value.trim(),
                type: recipeType 
            };
            
            if (currentMealForRecipe) {
                diary[currentDate][currentMealForRecipe].recipe = name;
                updateMeal(currentMealForRecipe);
            }
            
            currentMealForRecipe = null;
            currentRecipeToEdit = null;

            closeRecipeModal();
            if(document.getElementById('allRecipesModal').style.display === 'flex') {
                showAllRecipes();
            }
            autoSaveKawaii(); 
        }

        function deleteRecipeForMeal(meal = null){
            const recipeNameInput = document.getElementById('recipeName').value.trim();
            const currentMeal = meal || currentMealForRecipe;
            let nameToDelete = recipeNameInput;

            // Caso 1: Rimuovi riferimento dal Pasto (chiamata dal bottone nel pasto)
            if (meal) {
                nameToDelete = diary[currentDate][meal].recipe;
                if (!nameToDelete) return; 
                
                if(confirm(`Vuoi rimuovere il riferimento alla ricetta '${nameToDelete}' solo dal pasto ${meal}? La ricetta rester√† nel database.`)) {
                     if (diary[currentDate][currentMeal] && diary[currentDate][currentMeal].recipe === nameToDelete) {
                        delete diary[currentDate][currentMeal].recipe;
                    }
                    updateMeal(currentMeal);
                    autoSaveKawaii();
                }
                return;
            }
            
            // Caso 2: Elimina definitivamente dal Database (chiamata dalla modale)
            // Se la modale √® aperta per una ricetta specifica, usa quel nome.
            const selectedRecipeName = document.getElementById('existingRecipeSelect').value;
            nameToDelete = selectedRecipeName || recipeNameInput;

            if(!nameToDelete) return;

            if(confirm(`Sei sicuro di voler eliminare DEFINITIVAMENTE la ricetta '${nameToDelete}' dal database? Verr√† rimossa da tutti i giorni in cui √® usata.`)) {
                delete recipeDB[nameToDelete];
                
                Object.keys(diary).forEach(date => {
                    MEALS.forEach(m => {
                        if(diary[date][m] && diary[date][m].recipe === nameToDelete){
                            delete diary[date][m].recipe;
                        }
                    });
                });

                currentMealForRecipe = null;
                currentRecipeToEdit = null;

                closeRecipeModal();
                if(document.getElementById('allRecipesModal').style.display === 'flex') {
                    showAllRecipes();
                } else {
                    renderDiary(); 
                }
                autoSaveKawaii(); 
            }
        }

        function closeRecipeModal(){
            document.getElementById('recipeModal').style.display='none';
            // Ricarica il diario per aggiornare eventuali modifiche che potrebbero essere state fatte al database
            renderDiary(); 
        }

        // --- Ricette (Gestione Centralizzata)

        function showAllRecipes(){
            const container = document.getElementById('allRecipesContainer');
            const select = document.getElementById('allRecipesSelect');
            
            container.innerHTML = "";
            select.innerHTML = `<option value="">-- Nessuna ricetta selezionata --</option>`;
            document.getElementById('recipeDetailContainer').innerHTML = "Seleziona una ricetta sopra per vederne i dettagli.";
            
            document.getElementById('editRecipeBtn').disabled = true;
            document.getElementById('deleteRecipeBtn').disabled = true;

            if (Object.keys(recipeDB).length === 0) {
                container.innerHTML = "<p>Nessuna ricetta salvata. Usa il bottone 'Inserisci Nuova Ricetta'.</p>";
                document.getElementById('allRecipesModal').style.display='flex';
                return;
            }
            
            // 1. Popola il Selettore Generale 
            Object.keys(recipeDB).sort().forEach(r=>{
                select.innerHTML += `<option value="${r}">${r} (${recipeDB[r].type || 'Altro'})</option>`;
            });

            // 2. Crea le sezioni per tipo
            const groupedRecipes = {};
            RECIPE_TYPES.forEach(type => { groupedRecipes[type] = []; });
            
            Object.keys(recipeDB).forEach(name => {
                const recipe = recipeDB[name];
                const type = recipe.type && RECIPE_TYPES.includes(recipe.type) ? recipe.type : "Altro";
                groupedRecipes[type].push({name, ...recipe});
            });

            // 3. Renderizza le sezioni
            let htmlContent = '';
            
            const orderedTypes = ["Primo", "Secondo", "Contorno", "Dolce", "Altro"];
            
            orderedTypes.forEach(type => {
                const list = groupedRecipes[type];
                if (list && list.length > 0) {
                    htmlContent += `<div class="recipe-category-heading">${type} (${list.length})</div>`;
                    htmlContent += `<div class="recipe-list">`;
                    
                    list.sort((a, b) => a.name.localeCompare(b.name)).forEach(r => {
                        htmlContent += `
                            <div class="recipe-item-in-list">
                                <span>${r.name}</span>
                                <button title="Seleziona e vedi dettagli" onclick="selectRecipeInAllRecipes('${r.name}')">Vedi Dettagli</button>
                            </div>
                        `;
                    });
                    htmlContent += `</div>`;
                }
            });

            container.innerHTML = htmlContent;
            
            document.getElementById('allRecipesModal').style.display='flex';
        }
        
        function selectRecipeInAllRecipes(name) {
            document.getElementById('allRecipesSelect').value = name;
            displaySelectedRecipe();
        }

        function displaySelectedRecipe(){
            const select = document.getElementById('allRecipesSelect');
            const container = document.getElementById('recipeDetailContainer'); 
            const name = select.value;
            
            container.innerHTML = "Seleziona una ricetta sopra per vederne i dettagli.";
            document.getElementById('editRecipeBtn').disabled = true;
            document.getElementById('deleteRecipeBtn').disabled = true;
            
            if (name) {
                const rec = recipeDB[name];
                if(rec) {
                    container.innerHTML = `
                        <div class="recipeDiv" style="border-style: solid;">
                            <b>${name}</b> (${rec.type || 'N/D'})<br>
                            Ingredienti: ${rec.ingredients.replace(/\n/g, ', ')}<br>
                            Procedimento: ${rec.procedure}<br>
                            ‚è±Ô∏è Tempo: ${rec.cookTime}<br>
                            Metodo: ${rec.method}
                            ${rec.img?`<br><a href="${rec.img}" target="_blank">üîó Immagine</a>`:""}
                        </div>`;
                    
                    document.getElementById('editRecipeBtn').disabled = false;
                    document.getElementById('deleteRecipeBtn').disabled = false;
                }
            }
        }

        function insertNewRecipeFromAll() {
            openRecipeModal(null);
        }

        function editRecipeFromAll() {
            const name = document.getElementById('allRecipesSelect').value;
            if (!name) {
                alert("Seleziona una ricetta prima di modificare.");
                return;
            }
            
            currentRecipeToEdit = name; 
            openRecipeModal(null); 
        }

        function deleteRecipeFromAll() {
            const name = document.getElementById('allRecipesSelect').value;
            if (!name) {
                alert("Seleziona una ricetta da eliminare.");
                return;
            }

            if(confirm(`Sei sicuro di voler eliminare DEFINITIVAMENTE la ricetta '${name}' dal database? Verr√† rimossa da tutti i giorni in cui √® usata.`)) {
                delete recipeDB[name];
                
                Object.keys(diary).forEach(date => {
                    MEALS.forEach(m => {
                        if(diary[date][m] && diary[date][m].recipe === name){
                            delete diary[date][m].recipe;
                        }
                    });
                });

                autoSaveKawaii();
                showAllRecipes();
                renderDiary();
            }
        }

        function closeAllRecipesModal(){ 
            document.getElementById('allRecipesModal').style.display='none'; 
            renderDiary();
        }
        
        // --- Tabelle nutrizionali (NON MODIFICATE)
        function showNutritionModal(){
            const table = document.getElementById('nutritionTable');
            table.innerHTML = `<tr><th>Alimento</th><th>Kcal/100g</th><th>Carbs</th><th>Proteine</th><th>Grassi</th><th>Azioni</th></tr>`;
            foodDB.forEach((f,i)=>{
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${f.name}</td>
                                <td>${f.kcal100}</td>
                                <td>${f.carbs100}</td>
                                <td>${f.protein100}</td>
                                <td>${f.fat100}</td>
                                <td>
                                  <button onclick="editFoodTable(${i})">‚úèÔ∏è</button>
                                  <button onclick="removeFoodTable(${i})">üóëÔ∏è</button>
                                </td>`;
                table.appendChild(tr);
            });
            document.getElementById('nutritionModal').style.display='flex';
        }

        function editFoodTable(i){
            const f = foodDB[i];
            const name = prompt("Nome alimento:", f.name);
            if(!name) return;
            const kcal = parseFloat(prompt("Kcal/100g:", f.kcal100));
            const carbs = parseFloat(prompt("Carbs/100g:", f.carbs100));
            const protein = parseFloat(prompt("Proteine/100g:", f.protein100));
            const fat = parseFloat(prompt("Grassi/100g:", f.fat100));
            
            if (isNaN(kcal) || isNaN(carbs) || isNaN(protein) || isNaN(fat)) {
                alert("Valori nutrizionali non validi. Riprova.");
                return;
            }
            
            // Capitalizza la prima lettera del nome
            const cleanName = name.trim().charAt(0).toUpperCase() + name.trim().slice(1).toLowerCase();
            
            foodDB[i] = {name: cleanName, kcal100:kcal, carbs100:carbs, protein100:protein, fat100:fat, img:f.img};
            updateFoodList();
            showNutritionModal();
            autoSaveKawaii(); 
        }

        function removeFoodTable(i){
            if(confirm("Vuoi eliminare questo alimento?")){
                const foodName = foodDB[i].name;
                
                // Rimuovi anche da tutti i pasti nel diario
                Object.keys(diary).forEach(date => {
                    MEALS.forEach(m => {
                        if(diary[date][m]){
                            diary[date][m] = diary[date][m].filter(item => item.name !== foodName);
                        }
                    });
                });
                
                foodDB.splice(i,1);
                updateFoodList();
                showNutritionModal();
                renderDiary();
                autoSaveKawaii(); 
            }
        }
        function addNewFood(){
            const nameInput = prompt("Nome alimento:");
            if(!nameInput) return;
            
            // Capitalizza la prima lettera del nome
            const name = nameInput.trim().charAt(0).toUpperCase() + nameInput.trim().slice(1).toLowerCase();
            
            const kcal = parseFloat(prompt("Kcal/100g:"));
            const carbs = parseFloat(prompt("Carbs/100g:"));
            const protein = parseFloat(prompt("Proteine/100g:"));
            const fat = parseFloat(prompt("Grassi/100g:"));
            if (isNaN(kcal) || isNaN(carbs) || isNaN(protein) || isNaN(fat)) {
                alert("Valori nutrizionali non validi. Riprova.");
                return;
            }
            foodDB.push({name,kcal100:kcal,carbs100:carbs,protein100:protein,fat100:fat,img:""});
            updateFoodList();
            showNutritionModal();
            autoSaveKawaii(); 
            alert(`üçé Nuovo alimento "${name}" salvato nel database!`);
        }

        function closeNutritionModal(){
            document.getElementById('nutritionModal').style.display='none';
            updateFoodList();
            renderDiary(); 
        }

        // --- Gestione data
        function changeDay(date){
            currentDate = date;
            initDiaryForDate(currentDate);
            renderDiary();
        }

        // --- Sincronizzazione JSONBin (Chiavi corrette)
        function saveSyncJSONBin() {
            initDiaryForDate(currentDate);
            const allData = { diary, foodDB, recipeDB, savedAt: new Date().toISOString() };
            
            try {
              localStorage.setItem("kawaiiAllData", JSON.stringify(allData));
            } catch (e) {
              console.warn("Impossibile salvare localmente:", e);
            }
            
            fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                  "X-Master-Key": JSONBIN_MASTER_KEY 
                },
                body: JSON.stringify(allData)
            })
            .then(async (res) => {
                const text = await res.text();
                if (!res.ok) {
                  throw new Error(`HTTP ${res.status}: ${text}`);
                }
                alert("‚úÖ Dati sincronizzati con successo su Cloud!");
                console.log("‚úÖ JSONBin PUT OK:", text);
            })
            .catch((err) => {
                console.error("‚ùå Errore sincronizzazione Cloud (PUT):", err);
                alert("‚ö†Ô∏è Non √® stato possibile sincronizzare su Cloud. Dati salvati solo localmente come fallback.");
            });
        }

        function loadSyncJSONBin(){
            fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
                method: "GET",
                headers: {
                    "X-Access-Key": JSONBIN_READ_KEY 
                },
                mode: "cors"
            })
            .then(res => {
                if(!res.ok) throw new Error("HTTP " + res.status);
                return res.json();
            })
            .then(data => {
                if(!data || !data.record) throw new Error("Record Cloud vuoto");
                const rec = data.record;
                diary = rec.diary || {};
                foodDB = rec.foodDB || [];
                recipeDB = rec.recipeDB || {};
                
                initDiaryForDate(currentDate);
                updateFoodList();
                renderDiary();
                
                autoSaveKawaii(); 
                alert("üìÇ Dati caricati da Cloud!");
            })
            .catch(err => {
                console.warn("‚ùå Errore caricamento Cloud (GET):", err);
                
                try {
                    const data = localStorage.getItem("kawaiiAllData");
                    if(data){
                        const all = JSON.parse(data);
                        diary = all.diary || {};
                        foodDB = all.foodDB || [];
                        recipeDB = all.recipeDB || {};
                        
                        initDiaryForDate(currentDate);
                        updateFoodList();
                        renderDiary();
                        alert("üìÇ Cloud non raggiungibile ‚Äî caricati i dati locali come fallback.");
                    } else {
                        alert("‚ùå Cloud non raggiungibile e non ci sono dati locali salvati.");
                    }
                } catch(e){
                    console.error("Errore fallback locale:", e);
                    alert("‚ùå Errore nel caricamento: controlla console e connessione.");
                }
            });
        }

        // --- Avvio
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const localData = localStorage.getItem("kawaiiAllData");
                if (localData) {
                    const all = JSON.parse(localData);
                    diary = all.diary || diary;
                    foodDB = all.foodDB || foodDB;
                    recipeDB = all.recipeDB || recipeDB;
                }
            } catch (e) {
                console.error("Errore nel caricamento dei dati locali all'avvio:", e);
            }
            
            document.getElementById('dateInput').value = currentDate;
            
            initDiaryForDate(currentDate);
            updateFoodList();
            renderDiary();
        });
    </script>
</body>
</html>
